<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>1è¡Œæ—¥è¨˜ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
  <style>
    :root{
      --bg:#0b0f1a; --panel:#121a2a; --panel2:#0f1626;
      --text:#eaf0ff; --muted:#a9b4d1; --line:#25314e;
      --accent:#7aa2ff; --good:#54d18c; --warn:#ffd166; --bad:#ff5d7a;
      --shadow: 0 16px 50px rgba(0,0,0,.45);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", "Meiryo", Arial, sans-serif;
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(122,162,255,.25), transparent 60%),
        radial-gradient(900px 600px at 85% 20%, rgba(84,209,140,.20), transparent 55%),
        radial-gradient(900px 600px at 60% 90%, rgba(255,93,122,.16), transparent 60%),
        var(--bg);
      min-height:100vh;
    }
    header{
      max-width:1100px; margin:0 auto; padding:24px 16px 12px;
      display:flex; gap:12px; align-items:flex-end; justify-content:space-between;
    }
    h1{margin:0; font-size:22px; letter-spacing:.02em}
    header p{margin:6px 0 0; color:var(--muted); font-size:13px}
    .wrap{max-width:1100px; margin:0 auto; padding:12px 16px 28px; display:grid; gap:14px}
    .grid{display:grid; gap:14px; grid-template-columns: 1.05fr .95fr}
    @media (max-width: 920px){ .grid{grid-template-columns: 1fr} header{align-items:flex-start; flex-direction:column} }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(122,162,255,.18);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .in{padding:14px}
    .title{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.15);
    }
    .title strong{font-size:14px}
    .pill{
      font-size:12px; color:var(--muted);
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.15);
      padding:6px 10px; border-radius:999px;
    }
    .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    label{font-size:12px; color:var(--muted)}
    input[type="text"], textarea, select{
      width:100%;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      padding:11px 12px;
      border-radius:14px;
      outline:none;
    }
    textarea{min-height:92px; resize:vertical}
    .cols{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width:520px){ .cols{grid-template-columns:1fr} }
    .btns{display:flex; flex-wrap:wrap; gap:10px}
    button{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.20);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition: transform .05s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    button:hover{background:rgba(0,0,0,.30); border-color:rgba(122,162,255,.32)}
    button:active{transform:translateY(1px)}
    .primary{background:rgba(122,162,255,.22); border-color:rgba(122,162,255,.45)}
    .primary:hover{background:rgba(122,162,255,.28)}
    .good{background:rgba(84,209,140,.18); border-color:rgba(84,209,140,.35)}
    .bad{background:rgba(255,93,122,.18); border-color:rgba(255,93,122,.35)}
    .warn{background:rgba(255,209,102,.16); border-color:rgba(255,209,102,.30)}
    .muted{color:var(--muted); font-size:12px; line-height:1.5}
    .out{
      margin-top:12px;
      border-radius:16px;
      border:1px dashed rgba(255,255,255,.18);
      background:rgba(0,0,0,.18);
      padding:12px;
    }
    .out .line{
      font-size:15px;
      line-height:1.6;
      word-break:break-word;
      white-space:pre-wrap;
    }
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(0,0,0,.62);
      border:1px solid rgba(255,255,255,.15);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      box-shadow: var(--shadow);
      font-size:13px;
      opacity:0; pointer-events:none;
      transition: opacity .25s ease, transform .25s ease;
      z-index:9999;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-2px)}
    .list{
      display:flex; flex-direction:column; gap:10px;
      padding:14px;
    }
    .item{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      border-radius:16px;
      padding:12px;
    }
    .meta{display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between}
    .meta .left{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
    .tag{
      font-size:12px; padding:4px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      color:var(--muted);
      background:rgba(255,255,255,.04);
    }
    .tag.good{color:#c6ffe2}
    .tag.warn{color:#fff2c6}
    .tag.bad{color:#ffd0d8}
    .meta time{font-size:12px; color:var(--muted)}
    .item p{margin:10px 0 0; line-height:1.6; white-space:pre-wrap; word-break:break-word}
    .item .actions{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
    .item .actions button{padding:8px 10px; border-radius:12px; font-size:12px}
    .hr{height:1px; background:rgba(255,255,255,.08); margin:10px 0}
    .kbr{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:11px; padding:2px 6px; border-radius:8px;
      border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.25);
      color:var(--muted);
    }
    .small{font-size:12px}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>1è¡Œæ—¥è¨˜ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
      <p>æ°—åˆ†ã¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‹ã‚‰ã€Œãã‚Œã£ã½ã„1è¡Œã€ã‚’ä½œã£ã¦ä¿å­˜ã€‚<span class="kbr">Enter</span>ã§ç”Ÿæˆã€<span class="kbr">Ctrl/Cmd + K</span>ã§æ¤œç´¢ã¸ã€‚</p>
    </div>
    <div class="pill" id="stats">0ä»¶ / ä»Šæ—¥ 0ä»¶</div>
  </header>

  <main class="wrap">
    <section class="grid">
      <!-- Generator -->
      <div class="card">
        <div class="title">
          <strong>ç”Ÿæˆ</strong>
          <span class="pill">ä¿å­˜ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼ˆlocalStorageï¼‰</span>
        </div>
        <div class="in">
          <div class="cols">
            <div>
              <label for="mood">æ°—åˆ†</label>
              <select id="mood">
                <option value="good">ğŸ™‚ è‰¯ã„</option>
                <option value="neutral" selected>ğŸ˜ ãµã¤ã†</option>
                <option value="bad">ğŸ˜£ ã—ã‚“ã©ã„</option>
              </select>
            </div>
            <div>
              <label for="tone">æ–‡ä½“</label>
              <select id="tone">
                <option value="soft" selected>ã‚„ã•ã—ã„</option>
                <option value="cool">æ·¡ã€…</option>
                <option value="funny">ã¡ã‚‡ã„ç¬‘ã„</option>
                <option value="poem">è©©ã£ã½ã„</option>
                <option value="biz">ãƒ“ã‚¸ãƒã‚¹é¢¨</option>
              </select>
            </div>
          </div>

          <div style="margin-top:10px">
            <label for="kw">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»»æ„ãƒ»è¤‡æ•°OKï¼šã‚¹ãƒšãƒ¼ã‚¹/èª­ç‚¹åŒºåˆ‡ã‚Šï¼‰</label>
            <input id="kw" type="text" placeholder="ä¾‹ï¼šæ•£æ­©, ã‚³ãƒ¼ãƒ’ãƒ¼, ä»•äº‹, å‹ã ã¡" autocomplete="off" />
          </div>

          <div style="margin-top:10px">
            <label for="note">ã²ã¨è¨€ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼šç´ æã¨ã—ã¦æ··ãœã¾ã™ï¼‰</label>
            <textarea id="note" placeholder="ä¾‹ï¼šåˆå‰ä¸­ã«é›†ä¸­ã§ããŸã€‚å¤œã¯æ—©ã‚ã«å¯ãŸã„ã€‚"></textarea>
          </div>

          <div class="btns" style="margin-top:10px">
            <button class="primary" id="genBtn">ç”Ÿæˆã™ã‚‹ï¼ˆEnterï¼‰</button>
            <button id="copyBtn">ã‚³ãƒ”ãƒ¼</button>
            <button class="good" id="saveBtn">ä¿å­˜</button>
            <button class="warn" id="shuffleBtn" title="èªå½™ã‚»ãƒƒãƒˆã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å°‘ã—å¤‰ãˆã‚‹">å‘³å¤‰</button>
            <button class="bad" id="clearInputBtn">å…¥åŠ›ã‚¯ãƒªã‚¢</button>
          </div>

          <div class="out" aria-live="polite">
            <div class="muted small">ç”Ÿæˆçµæœ</div>
            <div class="line" id="output">ã¾ã ç”Ÿæˆã—ã¦ã„ã¾ã›ã‚“ã€‚</div>
            <div class="hr"></div>
            <div class="muted">
              ãƒ’ãƒ³ãƒˆï¼šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã€Œæ•£æ­©ã€ã€Œã‚³ãƒ¼ãƒ’ãƒ¼ã€ã¿ãŸã„ã«å…¥ã‚Œã‚‹ã¨ç²¾åº¦ãŒä¸ŠãŒã‚Šã¾ã™ã€‚<br>
              æ–‡ç« ã‚’ç›´ã—ã¦ã‹ã‚‰ä¿å­˜ã—ã¦ã‚‚OKï¼ˆç”Ÿæˆçµæœã‚’ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†ï¼‰ã€‚
            </div>
          </div>
        </div>
      </div>

      <!-- Manage -->
      <div class="card">
        <div class="title">
          <strong>ç®¡ç†</strong>
          <span class="pill">æ¤œç´¢ãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</span>
        </div>
        <div class="in">
          <div class="cols">
            <div>
              <label for="search">æ¤œç´¢</label>
              <input id="search" type="text" placeholder="ä¾‹ï¼šæ•£æ­© / ã—ã‚“ã©ã„ / 2026-02" autocomplete="off" />
            </div>
            <div>
              <label for="sort">ä¸¦ã³</label>
              <select id="sort">
                <option value="new" selected>æ–°ã—ã„é †</option>
                <option value="old">å¤ã„é †</option>
              </select>
            </div>
          </div>

          <div class="btns" style="margin-top:10px">
            <button id="exportBtn">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆJSONï¼‰</button>
            <button id="importBtn">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
            <button class="bad" id="wipeBtn">å…¨å‰Šé™¤</button>
          </div>

          <div class="muted" style="margin-top:10px">
            ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¯JSONã‚’è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨é€”ã€‚<br>
            ãªãŠã“ã®ãƒšãƒ¼ã‚¸ã¯ã‚µãƒ¼ãƒä¸è¦ã§å‹•ãã¾ã™ï¼ˆindex.htmlã ã‘ï¼‰ã€‚
          </div>
        </div>
      </div>
    </section>

    <!-- List -->
    <section class="card">
      <div class="title">
        <strong>æ—¥è¨˜ãƒ­ã‚°</strong>
        <span class="pill" id="filterPill">ãƒ•ã‚£ãƒ«ã‚¿: ãªã—</span>
      </div>
      <div class="list" id="list"></div>
    </section>
  </main>

  <div class="toast" id="toast">Copied!</div>

  <script>
    // ========== Utilities ==========
    const $ = (sel) => document.querySelector(sel);
    const STORAGE_KEY = "one_line_diary_v1";

    function nowISO() {
      const d = new Date();
      const pad = (n) => String(n).padStart(2, "0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function todayYYYYMMDD() {
      const d = new Date();
      const pad = (n) => String(n).padStart(2, "0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    function toast(msg) {
      const t = $("#toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(toast._tm);
      toast._tm = setTimeout(() => t.classList.remove("show"), 1200);
    }

    function safeJSONParse(str) {
      try { return { ok:true, value: JSON.parse(str) }; }
      catch(e){ return { ok:false, error:e }; }
    }

    // ========== Templates (lightweight) ==========
    const vocab = {
      openers: [
        "ä»Šæ—¥ã¯", "ãªã‚“ã ã‹ä»Šæ—¥ã¯", "çµæœã¨ã—ã¦ä»Šæ—¥ã¯", "ãµã¨æ°—ã¥ã„ãŸã‚‰ä»Šæ—¥ã¯", "ã¨ã‚Šã‚ãˆãšä»Šæ—¥ã¯"
      ],
      good: {
        soft: [
          "å°ã•ãã†ã¾ãã„ã£ãŸã€‚", "æ°—æŒã¡ãŒå‰ã«é€²ã‚“ã ã€‚", "ã¡ã‚ƒã‚“ã¨å‘¼å¸ã§ããŸæ—¥ã€‚", "è‡ªåˆ†ã«ã‚„ã•ã—ãã§ããŸã€‚"
        ],
        cool: [
          "é€²æ—ã‚ã‚Šã€‚", "æ·¡ã€…ã¨ç‰‡ä»˜ã‘ãŸã€‚", "ã‚„ã‚‹ã¹ãã“ã¨ã‚’ã‚„ã£ãŸã€‚", "æ°—åˆ†ã¯ä¸Šå‘ãã€‚"
        ],
        funny: [
          "ãªãœã‹å‹ã£ãŸæ°—ãŒã™ã‚‹ã€‚", "ä¸–ç•ŒãŒã¡ã‚‡ã£ã¨ã ã‘å‘³æ–¹ã€‚", "ä»Šæ—¥ã®è‡ªåˆ†ã€ãˆã‚‰ã„ï¼ˆå½“ç¤¾æ¯”ï¼‰ã€‚", "é‹ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ãŸã€‚"
        ],
        poem: [
          "å…‰ãŒå°‘ã—å¢—ãˆãŸã€‚", "èƒ¸ã®ä¸­ã«ä½™ç™½ãŒã§ããŸã€‚", "é ãã®éŸ³ã¾ã§å±Šã„ãŸã€‚", "ä»Šæ—¥ã‚’ã‚„ã‚ã‚‰ã‹ãæŠ˜ã‚ŠãŸãŸã‚€ã€‚"
        ],
        biz: [
          "å‰é€²ã‚’ç¢ºèªã€‚", "æˆæœã‚’ä¸€éƒ¨å›åã€‚", "è‰¯å¥½ãªã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã‚’ç¶­æŒã€‚", "ãƒªã‚ºãƒ ãŒæ•´ã£ãŸã€‚"
        ]
      },
      neutral: {
        soft: [
          "ç„¡ç†ã›ãšå›ã›ãŸã€‚", "ã»ã©ã»ã©ã§ã‚ˆã‹ã£ãŸã€‚", "ä»Šæ—¥ã¯ã“ã‚Œã§ååˆ†ã€‚", "ã¡ã‚ƒã‚“ã¨ç”Ÿæ´»ã—ãŸã€‚"
        ],
        cool: [
          "é€šå¸¸é‹è»¢ã€‚", "å¤§ããªæ³¢ãªã—ã€‚", "äºˆå®šé€šã‚Šã€‚", "å¯ã‚‚ãªãä¸å¯ã‚‚ãªãã€‚"
        ],
        funny: [
          "ä»Šæ—¥ã‚‚åœ°çƒã«ä½ã‚ãŸã€‚", "ãƒã‚°ã¯å‡ºãŸãŒè‡´å‘½å‚·ã§ã¯ãªã„ã€‚", "HPã¯æ¸›ã£ãŸã‘ã©ã‚¼ãƒ­ã˜ã‚ƒãªã„ã€‚", "ã¨ã‚Šã‚ãˆãšç”Ÿé‚„ã€‚"
        ],
        poem: [
          "æ›‡ã‚Šã®ã¾ã¾ã€æ­©ã‘ãŸã€‚", "é™ã‹ãªæ™‚é–“ãŒç¶šã„ãŸã€‚", "ç™½é»’ã®é–“ã«è‰²ãŒã‚ã‚‹ã€‚", "ä½•ã‚‚ãªã„ã“ã¨ã‚‚ã€ã‚ã‚‹ã€‚"
        ],
        biz: [
          "å®šå¸¸ç¨¼åƒã€‚", "ãƒªã‚¹ã‚¯ä½ã‚ã§æ¨ç§»ã€‚", "ã‚¿ã‚¹ã‚¯ã‚’å¹³æº–åŒ–ã€‚", "ç¾çŠ¶ç¶­æŒã‚’é”æˆã€‚"
        ]
      },
      bad: {
        soft: [
          "ã‚ˆãè€ãˆãŸã€‚", "ä»Šæ—¥ã¯ä¼‘ã‚€æ—¥ã ã£ãŸã€‚", "è‡ªåˆ†ã‚’å®ˆã‚ŒãŸã‚‰å‹ã¡ã€‚", "æ˜æ—¥ã«ã¤ãªã’ã‚‹ã ã‘ã§ååˆ†ã€‚"
        ],
        cool: [
          "ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ä¸è‰¯ã€‚", "æ¶ˆè€—ãŒå¤§ãã„ã€‚", "å›å¾©ã‚’å„ªå…ˆã€‚", "è² è·ãŒé«˜ã‹ã£ãŸã€‚"
        ],
        funny: [
          "ä»Šæ—¥ã¯ã‚‚ã†åº—ã˜ã¾ã„ã€‚", "è„³ã¿ããŒä½é›»åŠ›ãƒ¢ãƒ¼ãƒ‰ã€‚", "æƒ…ç·’ãŒWi-Fiåˆ‡ã‚Œã€‚", "äººç”Ÿã€ãŸã¾ã«ãƒ¡ãƒ³ãƒ†ã€‚"
        ],
        poem: [
          "æš—ã„æ°´ã®åº•ã§æ¯ã‚’ã™ã‚‹ã€‚", "é›¨ã®éŸ³ã ã‘ãŒå‘³æ–¹ã€‚", "ã²ã³å‰²ã‚ŒãŸã¾ã¾ã€ç«‹ã£ã¦ã„ãŸã€‚", "å¤œã«ã»ã©ã‘ã¦ã€ã¾ãŸçµã¶ã€‚"
        ],
        biz: [
          "ç¨¼åƒç‡ä½ä¸‹ã€‚", "å›å¾©è¨ˆç”»ãŒå¿…è¦ã€‚", "å„ªå…ˆåº¦ã‚’è¦‹ç›´ã™ã€‚", "ç„¡ç†ãªç¨¼åƒã¯å›é¿ã€‚"
        ]
      },
      connectors: [
        "ã§ã‚‚", "ãã—ã¦", "ã ã‹ã‚‰", "ã‘ã‚Œã©", "ãã‚Œã§ã‚‚", "ã¡ãªã¿ã«"
      ],
      endings: [
        "æ˜æ—¥ã¯å°‘ã—ã ã‘è»½ãã—ãŸã„ã€‚", "æ¬¡ã¯ä¸€æ­©ã§ã„ã„ã€‚", "å¯ãŸã‚‰ã ã„ãŸã„è§£æ±ºã€‚", "æ°´ã¨å…‰ã‚’è¶³ã—ã¦ã„ãã€‚", "ä»Šæ—¥ã‚’ã“ã“ã§é–‰ã˜ã‚‹ã€‚"
      ],
      actions: [
        "æ•£æ­©", "ã‚³ãƒ¼ãƒ’ãƒ¼", "æ—©å¯", "ç‰‡ã¥ã‘", "ã‚¹ãƒˆãƒ¬ãƒƒãƒ", "èª­æ›¸", "ãƒ¡ãƒ¢", "æ·±å‘¼å¸", "éŸ³æ¥½", "æ¹¯èˆ¹"
      ]
    };

    let salt = Math.random(); // "å‘³å¤‰"ç”¨

    function pick(arr) {
      return arr[Math.floor((Math.random() + salt*0.00001) * arr.length) % arr.length];
    }

    function splitKeywords(s) {
      return (s || "")
        .replace(/[ã€ï¼Œ]/g, " ")
        .split(/\s+/)
        .map(x => x.trim())
        .filter(Boolean)
        .slice(0, 6);
    }

    function buildLine({mood, tone, keywords, note}) {
      const opener = pick(vocab.openers);
      const moodKey = mood === "good" ? "good" : (mood === "bad" ? "bad" : "neutral");
      const tail = pick(vocab[moodKey][tone] || vocab[moodKey].soft);

      const kws = keywords.length ? keywords : [pick(vocab.actions)];
      const kw = kws.length === 1 ? `ã€Œ${kws[0]}ã€` : `ã€Œ${kws[0]}ã€ã¨ã€Œ${kws[1]}ã€`;

      const conn = pick(vocab.connectors);
      const end = pick(vocab.endings);

      // noteã‚’çŸ­ãæ··ãœã‚‹
      const memo = (note || "").trim();
      const memoPart = memo
        ? ` ${conn}ã€${memo.replace(/\s+/g," ").slice(0, 28)}`
        : ` ${conn}ã€${kw}ãŒåŠ¹ã„ãŸã€‚`;

      // 1è¡Œã£ã½ãï¼ˆé•·ã™ãã‚‹æ™‚ã¯è»½ãä¸¸ã‚ã‚‹ï¼‰
      let line = `${opener}${tail}${memoPart} ${end}`;
      line = line.replace(/\s+/g, " ").trim();
      if (line.length > 78) {
        line = line.slice(0, 76).replace(/[ã€,]\s*[^ã€,]*$/, "") + "â€¦";
      }
      return line;
    }

    // ========== Storage ==========
    function loadAll() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      const p = safeJSONParse(raw);
      if (!p.ok || !Array.isArray(p.value)) return [];
      return p.value;
    }
    function saveAll(items) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    }

    // ========== App state ==========
    let items = loadAll();
    let currentLine = "";

    // ========== Render ==========
    function moodLabel(m) {
      if (m === "good") return "ğŸ™‚ è‰¯ã„";
      if (m === "bad") return "ğŸ˜£ ã—ã‚“ã©ã„";
      return "ğŸ˜ ãµã¤ã†";
    }
    function moodClass(m) {
      if (m === "good") return "good";
      if (m === "bad") return "bad";
      return "warn";
    }

    function updateStats() {
      const today = todayYYYYMMDD();
      const todayCount = items.filter(x => (x.date || "").startsWith(today)).length;
      $("#stats").textContent = `${items.length}ä»¶ / ä»Šæ—¥ ${todayCount}ä»¶`;
    }

    function renderList() {
      const q = $("#search").value.trim().toLowerCase();
      const sort = $("#sort").value;

      let filtered = items.slice();
      if (q) {
        filtered = filtered.filter(it => {
          const hay = `${it.date} ${it.mood} ${it.tone} ${(it.keywords||[]).join(" ")} ${it.text}`.toLowerCase();
          return hay.includes(q);
        });
        $("#filterPill").textContent = `ãƒ•ã‚£ãƒ«ã‚¿: "${q}"`;
      } else {
        $("#filterPill").textContent = `ãƒ•ã‚£ãƒ«ã‚¿: ãªã—`;
      }

      filtered.sort((a,b) => sort === "new"
        ? (b.ts - a.ts)
        : (a.ts - b.ts)
      );

      const el = $("#list");
      el.innerHTML = "";

      if (!filtered.length) {
        const empty = document.createElement("div");
        empty.className = "item";
        empty.innerHTML = `
          <div class="meta">
            <div class="left">
              <span class="tag">ã¾ã ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</span>
            </div>
            <time></time>
          </div>
          <p>å³ä¸Šã®ç”Ÿæˆã‹ã‚‰ã€Œä¿å­˜ã€ã‚’æŠ¼ã™ã¨ã“ã“ã«æºœã¾ã‚Šã¾ã™ã€‚</p>
        `;
        el.appendChild(empty);
        updateStats();
        return;
      }

      for (const it of filtered) {
        const div = document.createElement("div");
        div.className = "item";
        const kw = (it.keywords || []).slice(0,6);
        const kwTags = kw.map(k => `<span class="tag">${escapeHtml(k)}</span>`).join("");
        div.innerHTML = `
          <div class="meta">
            <div class="left">
              <span class="tag ${moodClass(it.mood)}">${moodLabel(it.mood)}</span>
              <span class="tag">${escapeHtml(labelTone(it.tone))}</span>
              ${kwTags}
            </div>
            <time>${escapeHtml(it.date)}</time>
          </div>
          <p>${escapeHtml(it.text)}</p>
          <div class="actions">
            <button data-act="copy">ã‚³ãƒ”ãƒ¼</button>
            <button data-act="edit">ç·¨é›†</button>
            <button data-act="del" class="bad">å‰Šé™¤</button>
          </div>
        `;

        div.querySelector('[data-act="copy"]').addEventListener("click", async () => {
          await copyText(it.text);
        });

        div.querySelector('[data-act="edit"]').addEventListener("click", () => {
          const next = prompt("ç·¨é›†ï¼ˆ1è¡Œæ—¥è¨˜ï¼‰", it.text);
          if (next == null) return;
          const trimmed = next.trim();
          if (!trimmed) return toast("ç©ºã¯ä¿å­˜ã§ãã¾ã›ã‚“");
          it.text = trimmed;
          saveAll(items);
          renderList();
          toast("æ›´æ–°ã—ã¾ã—ãŸ");
        });

        div.querySelector('[data-act="del"]').addEventListener("click", () => {
          if (!confirm("ã“ã®æ—¥è¨˜ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
          items = items.filter(x => x.id !== it.id);
          saveAll(items);
          renderList();
          toast("å‰Šé™¤ã—ã¾ã—ãŸ");
        });

        el.appendChild(div);
      }

      updateStats();
    }

    function labelTone(t){
      return ({
        soft:"ã‚„ã•ã—ã„",
        cool:"æ·¡ã€…",
        funny:"ã¡ã‚‡ã„ç¬‘ã„",
        poem:"è©©ã£ã½ã„",
        biz:"ãƒ“ã‚¸ãƒã‚¹é¢¨"
      })[t] || t;
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        toast("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
      }catch(e){
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        toast("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
      }
    }

    // ========== Generator actions ==========
    function generate() {
      const mood = $("#mood").value;
      const tone = $("#tone").value;
      const keywords = splitKeywords($("#kw").value);
      const note = $("#note").value;

      currentLine = buildLine({mood, tone, keywords, note});
      $("#output").textContent = currentLine;
    }

    function saveCurrent() {
      const text = ($("#output").textContent || "").trim();
      if (!text || text === "ã¾ã ç”Ÿæˆã—ã¦ã„ã¾ã›ã‚“ã€‚") return toast("ã¾ãšç”Ÿæˆã—ã¦ã­");

      const item = {
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2),
        ts: Date.now(),
        date: nowISO(),
        mood: $("#mood").value,
        tone: $("#tone").value,
        keywords: splitKeywords($("#kw").value),
        text
      };
      items.push(item);
      saveAll(items);
      renderList();
      toast("ä¿å­˜ã—ã¾ã—ãŸ");
    }

    // outputã‚’ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
    $("#output").addEventListener("click", () => {
      const text = ($("#output").textContent || "").trim();
      if (!text || text === "ã¾ã ç”Ÿæˆã—ã¦ã„ã¾ã›ã‚“ã€‚") return;
      const next = prompt("ç”Ÿæˆçµæœã‚’ç·¨é›†ï¼ˆä¿å­˜å‰ã§ã‚‚OKï¼‰", text);
      if (next == null) return;
      const trimmed = next.trim();
      if (!trimmed) return toast("ç©ºã«ã¯ã§ãã¾ã›ã‚“");
      $("#output").textContent = trimmed;
      currentLine = trimmed;
      toast("ç·¨é›†ã—ã¾ã—ãŸ");
    });

    // Buttons
    $("#genBtn").addEventListener("click", generate);
    $("#shuffleBtn").addEventListener("click", () => { salt = Math.random(); generate(); toast("å‘³å¤‰ã—ã¾ã—ãŸ"); });
    $("#saveBtn").addEventListener("click", saveCurrent);
    $("#copyBtn").addEventListener("click", async () => {
      const text = ($("#output").textContent || "").trim();
      if (!text || text === "ã¾ã ç”Ÿæˆã—ã¦ã„ã¾ã›ã‚“ã€‚") return toast("ã¾ãšç”Ÿæˆã—ã¦ã­");
      await copyText(text);
    });
    $("#clearInputBtn").addEventListener("click", () => {
      $("#kw").value = "";
      $("#note").value = "";
      toast("å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢");
    });

    // Search/sort
    $("#search").addEventListener("input", renderList);
    $("#sort").addEventListener("change", renderList);

    // Export/Import/Wipe
    $("#exportBtn").addEventListener("click", async () => {
      const data = JSON.stringify(items, null, 2);
      await copyText(data);
      toast("JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
      alert("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ(JSON)ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚\nãƒ¡ãƒ¢å¸³ãªã©ã«è²¼ã‚Šä»˜ã‘ã¦ä¿å­˜ã§ãã¾ã™ã€‚");
    });

    $("#importBtn").addEventListener("click", () => {
      const txt = prompt("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹JSONã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼ˆé…åˆ—ï¼‰");
      if (!txt) return;
      const p = safeJSONParse(txt);
      if (!p.ok || !Array.isArray(p.value)) {
        alert("JSONã®å½¢å¼ãŒé•ã„ã¾ã™ï¼ˆé…åˆ—ãŒå¿…è¦ï¼‰ã€‚");
        return;
      }
      // ç°¡æ˜“ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      const incoming = p.value
        .filter(x => x && typeof x === "object" && typeof x.text === "string")
        .map(x => ({
          id: x.id || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2)),
          ts: typeof x.ts === "number" ? x.ts : Date.now(),
          date: x.date || nowISO(),
          mood: x.mood || "neutral",
          tone: x.tone || "soft",
          keywords: Array.isArray(x.keywords) ? x.keywords.slice(0,6).map(String) : [],
          text: String(x.text).trim()
        }))
        .filter(x => x.text);

      if (!incoming.length) return alert("å–ã‚Šè¾¼ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");

      // æ—¢å­˜ã¨ãƒãƒ¼ã‚¸ï¼ˆidé‡è¤‡ã¯å¾Œå‹ã¡ï¼‰
      const map = new Map(items.map(x => [x.id, x]));
      for (const it of incoming) map.set(it.id, it);
      items = Array.from(map.values());
      saveAll(items);
      renderList();
      toast("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ");
    });

    $("#wipeBtn").addEventListener("click", () => {
      if (!items.length) return toast("ãƒ­ã‚°ã¯ç©ºã§ã™");
      if (!confirm("å…¨å‰Šé™¤ã—ã¾ã™ã€‚æœ¬å½“ã«ï¼Ÿï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰")) return;
      if (!confirm("æœ€çµ‚ç¢ºèªï¼šã»ã‚“ã¨ã«å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      items = [];
      saveAll(items);
      renderList();
      toast("å…¨å‰Šé™¤ã—ã¾ã—ãŸ");
    });

    // Keyboard shortcuts
    document.addEventListener("keydown", (e) => {
      const isMac = /Mac|iPhone|iPad|iPod/.test(navigator.platform);
      const cmd = isMac ? e.metaKey : e.ctrlKey;

      // Enter to generate (avoid when typing in textarea with Shift+Enter etc.)
      if (e.key === "Enter" && !e.shiftKey) {
        const active = document.activeElement;
        const isTextArea = active && active.tagName === "TEXTAREA";
        if (!isTextArea) {
          e.preventDefault();
          generate();
        }
      }

      // Ctrl/Cmd + K focus search
      if (cmd && e.key.toLowerCase() === "k") {
        e.preventDefault();
        $("#search").focus();
        toast("æ¤œç´¢ã¸");
      }
    });

    // Initial render
    generate();
    renderList();
    updateStats();
  </script>
</body>
</html>
