<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Plain Memo</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-color:#121212;
      --gutter-bg:#1a1a1a;
      --text-color:#e0e0e0;
      --line-number-color:#555;
      --accent-color:#ffffff;
      --highlight-line-bg:#252525;
      --font-family:'JetBrains Mono', monospace;
      --line-height-mult:1.6;
      --base-font-size: 16px;

      /* UI colors */
      --ui-bg:#121212;
      --ui-border:#444;
      --ui-text:#e0e0e0;
      --ui-focus:#ffffff;
    }

    body, html{
      margin:0; padding:0; height:100%;
      background-color:var(--bg-color);
      color:var(--text-color);
      font-family:var(--font-family);
      overflow:hidden;
      position:fixed;
      width:100%;
    }

    .container{
      display:flex;
      height:calc(100svh - 35px);
      width:100%;
      position:relative;
    }

    #line-numbers{
      width:50px;
      padding:20px 0;
      text-align:right;
      background-color:var(--gutter-bg);
      color:var(--line-number-color);
      user-select:none;
      overflow:hidden;
      border-right:1px solid #222;
      white-space:pre;
      pointer-events:none;
      box-sizing:border-box;
      font-size: var(--base-font-size);
      line-height: calc(var(--base-font-size) * var(--line-height-mult));
      z-index:0;
    }

    #editor{
      flex:1;
      padding:20px;
      border:none;
      outline:none;
      background:transparent;
      color:inherit;
      font-family:inherit;
      font-size: var(--base-font-size);
      line-height: var(--line-height-mult);
      resize:none;
      overflow:auto;
      -webkit-appearance:none;
      caret-color:var(--accent-color);
      z-index:2;
      box-sizing:border-box;
      white-space:pre;
    }

    #current-line{
      position:absolute;
      top:0;
      left:0;
      right:0;
      height: calc(var(--base-font-size) * var(--line-height-mult));
      background:var(--highlight-line-bg);
      opacity:0.85;
      pointer-events:none;
      z-index:1;
      transform:translateY(-9999px);
    }

    .status-bar{
      height:35px;
      background:#1a1a1a;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:0 15px;
      font-size:11px;
      color:#777;
      border-top:1px solid #222;
      box-sizing:border-box;
    }

    .controls{
      display:flex;
      align-items:center;
      gap:15px;
    }

    .wrap-controls select, .wrap-controls input{
      background:var(--ui-bg);
      border:1px solid var(--ui-border);
      color:var(--ui-text);
      font-size:10px;
      padding:3px 6px;
      border-radius:2px;
      outline:none;
    }

    .controls button{
      background:transparent;
      border:1px solid var(--ui-border);
      color:#aaa;
      padding:3px 10px;
      cursor:pointer;
      font-size:10px;
      border-radius:2px;
      transition:0.2s;
    }

    #toast{
      position:fixed;
      bottom:60px;
      left:50%;
      transform:translateX(-50%);
      background:#1f1f1f;
      color:#fff;
      padding:8px 16px;
      font-size:12px;
      border-radius:6px;
      opacity:0;
      pointer-events:none;
      transition:0.25s;
      border:1px solid #333;
      z-index:999;
    }
    #toast.show{ opacity:1; }

    #mirror{
      position:absolute; top:-9999px; left:-9999px; visibility:hidden;
      white-space:pre-wrap; word-break:break-word; overflow-wrap:anywhere;
      font-size: var(--base-font-size);
      line-height: var(--line-height-mult);
    }
  </style>
</head>
<body>

  <div class="container">
    <div id="line-numbers">1</div>
    <div id="current-line"></div>
    <textarea id="editor" spellcheck="false" autocomplete="off" placeholder="Type something..."></textarea>
  </div>

  <div class="status-bar">
    <div style="font-weight:500; color:#999; letter-spacing:1px;">PLAIN MEMO</div>
    <div class="controls">
      <span id="stats">LN: 1 | CH: 0</span>
      <div class="wrap-controls">
        <select id="wrapMode">
          <option value="auto">Auto Wrap</option>
          <option value="col">Column Wrap</option>
          <option value="off" selected>No Wrap</option>
        </select>
        <input id="wrapCol" type="number" min="20" max="300" value="80" style="display:none; width:45px;" />
      </div>
      <button onclick="downloadText()">Export</button>
    </div>
  </div>

  <div id="toast"></div>
  <div id="mirror"></div>

  <script>
    const editor = document.getElementById('editor');
    const lineNumbers = document.getElementById('line-numbers');
    const stats = document.getElementById('stats');
    const toastEl = document.getElementById('toast');
    const currentLineEl = document.getElementById('current-line');
    const mirror = document.getElementById('mirror');
    const wrapModeSel = document.getElementById('wrapMode');
    const wrapColInput = document.getElementById('wrapCol');

    const DATA_KEY = 'plain-memo-data-v1';
    const WRAP_MODE_KEY = 'plain-memo-wrap-mode';
    const FONT_SIZE = 16;
    const LINE_HEIGHT = Math.round(FONT_SIZE * 1.6);

    function showToast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      setTimeout(() => toastEl.classList.remove('show'), 1200);
    }

    function applyWrapMode(){
      const mode = wrapModeSel.value;
      wrapColInput.style.display = (mode === 'col') ? 'inline-block' : 'none';

      if (mode === 'auto') {
        editor.style.whiteSpace = 'pre-wrap';
        editor.style.maxWidth = '';
      } else if (mode === 'col') {
        editor.style.whiteSpace = 'pre-wrap';
        editor.style.maxWidth = `${wrapColInput.value}ch`;
      } else {
        editor.style.whiteSpace = 'pre';
        editor.style.maxWidth = '';
      }
      
      localStorage.setItem(WRAP_MODE_KEY, mode);
      syncMirrorStyle();
      updateEditor();
      updateCurrentLineHighlight();
    }

    function updateEditor(){
      const text = editor.value;
      // 改行文字の数に基づいて行数を算出
      const lines = text.split('\n').length;
      
      let numbers = "";
      for (let i = 1; i <= lines; i++) {
        numbers += i + "\n";
      }
      lineNumbers.textContent = numbers;

      stats.innerText = `LN: ${lines} | CH: ${text.length}`;
      localStorage.setItem(DATA_KEY, text);
    }

    function syncMirrorStyle(){
      const cs = getComputedStyle(editor);
      mirror.style.width = cs.width;
      mirror.style.padding = cs.padding;
      mirror.style.boxSizing = cs.boxSizing;
      mirror.style.whiteSpace = editor.style.whiteSpace;
    }

    function getCaretVisualTop(){
      const pos = editor.selectionStart || 0;
      const text = editor.value;
      mirror.innerHTML = text.slice(0, pos).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) + '<span id="caret-marker">|</span>';
      const marker = document.getElementById('caret-marker');
      return marker ? marker.offsetTop : 0;
    }

    function updateCurrentLineHighlight(){
      const gutterWidth = lineNumbers.getBoundingClientRect().width;
      currentLineEl.style.left = gutterWidth + "px";
      const y = getCaretVisualTop() - editor.scrollTop;
      currentLineEl.style.transform = `translateY(${Math.round(y)}px)`;
    }

    function downloadText(){
      if (!editor.value) return showToast("Empty");
      const blob = new Blob([editor.value], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `memo_${Date.now()}.txt`;
      a.click();
      showToast("✔ Exported");
    }

    // --- Event Listeners ---
    editor.addEventListener('input', () => { 
      updateEditor(); 
      updateCurrentLineHighlight(); 
    });

    // スクロール時の行番号同期とハイライト追従
    editor.addEventListener('scroll', () => {
      lineNumbers.scrollTop = editor.scrollTop;
      updateCurrentLineHighlight();
    });

    ['click','keyup','select'].forEach(ev => {
      editor.addEventListener(ev, updateCurrentLineHighlight);
    });

    wrapModeSel.addEventListener('change', applyWrapMode);
    wrapColInput.addEventListener('change', applyWrapMode);

    window.addEventListener('resize', () => {
      syncMirrorStyle();
      updateCurrentLineHighlight();
    });

    // --- Shortcuts & Keyboard ---
    editor.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        downloadText();
      }
      if (e.key === 'Tab') {
        e.preventDefault();
        const start = editor.selectionStart;
        editor.value = editor.value.substring(0, start) + "    " + editor.value.substring(editor.selectionEnd);
        editor.selectionStart = editor.selectionEnd = start + 4;
        updateEditor();
        updateCurrentLineHighlight();
      }
    });

    window.onload = () => {
      editor.value = localStorage.getItem(DATA_KEY) || "";
      const savedMode = localStorage.getItem(WRAP_MODE_KEY);
      if (savedMode) wrapModeSel.value = savedMode;
      
      applyWrapMode();
      updateEditor();
      if (!('ontouchstart' in window)) editor.focus();
    };
  </script>
</body>
</html>