<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ローマ字タイピング（5分）</title>
<style>
  :root{
    --bg:#f7f7f7;
    --bar:#6f8fb2;
    --accent:#0aa0d7;
    --accent2:#ff8a00;
    --text:#2b2b2b;
    --muted:#777;
    --key:#ffffff;
    --keyBorder:#d9d9d9;
    --keyShadow:0 1px 0 rgba(0,0,0,.05);
    --hl:#00a3ff;
    --hl2:#ffb703;
    --good:#0a84ff;
    --bad:#ff3b30;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", sans-serif;
    background:var(--bg);
    color:var(--text);
  }
  .topbar{
    height:56px;
    background:var(--bar);
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 16px;
  }
  .topbar .title{
    font-weight:700;
    letter-spacing:.02em;
  }
  .topbar .right{
    display:flex;
    align-items:center;
    gap:14px;
    white-space:nowrap;
  }
  .timerWrap{
    display:flex;
    align-items:center;
    gap:10px;
  }
  .timerLabel{opacity:.95;font-weight:700}
  .progress{
    width:180px;
    height:12px;
    background:rgba(255,255,255,.25);
    border-radius:999px;
    overflow:hidden;
  }
  .progress > div{
    height:100%;
    width:100%;
    background:#66d100; /* benesseっぽい緑 */
    transform-origin:left;
    transform:scaleX(1);
  }
  .timeText{
    font-weight:800;
    font-size:28px;
    letter-spacing:.03em;
  }
  .endBtn{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:10px 14px;
    border-radius:999px;
    border:none;
    background:var(--accent2);
    color:#fff;
    font-weight:800;
    cursor:pointer;
  }
  .endBtn:active{transform:translateY(1px)}
  .endIcon{
    width:22px;height:22px;border-radius:50%;
    background:#fff; color:var(--accent2);
    display:grid; place-items:center;
    font-weight:900; line-height:1;
  }

  .wrap{
    max-width:1100px;
    margin:0 auto;
    padding:32px 16px 40px;
  }

  .countBadge{
    display:inline-flex;
    border-radius:6px;
    overflow:hidden;
    box-shadow:0 1px 0 rgba(0,0,0,.06);
    margin:0 auto 22px;
  }
  .countBadge .label{
    background:#bfe6ff;
    padding:10px 18px;
    font-weight:800;
    color:#004d75;
  }
  .countBadge .val{
    background:#eee;
    padding:10px 18px;
    min-width:64px;
    text-align:right;
    font-weight:900;
    color:#ff6a00;
  }

  .center{
    text-align:center;
    margin-top:8px;
  }
  .jp{
    font-size:44px;
    font-weight:800;
    color:#0a84ff;
    line-height:1.25;
  }
  .divider{
    height:2px;
    background:#cfcfcf;
    max-width:720px;
    margin:10px auto 10px;
  }
  .kana{
    font-size:20px;
    color:#333;
    margin:0 0 6px;
  }
  .romaji{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    font-size:22px;
    font-weight:800;
    letter-spacing:.08em;
    color:#111;
    margin:0 0 10px;
  }
  .romaji .good{color:#111}
  .romaji .typedGood{color:#111}
  .romaji .typedBad{color:var(--bad)}
  .romaji .rest{color:#b7b7b7}

  .hint{
    margin-top:18px;
    font-size:36px;
    font-weight:900;
    color:var(--accent2);
  }
  .subhint{
    margin-top:6px;
    color:#666;
    font-weight:700;
  }

  /* Keyboard */
  .kbWrap{
    margin:28px auto 0;
    width:min(980px, 100%);
    background:#f0f0f0;
    border-radius:14px;
    padding:16px 14px;
    box-shadow: 0 2px 10px rgba(0,0,0,.06);
  }
  .row{display:flex; gap:6px; justify-content:center; margin:6px 0;}
  .key{
    background:var(--key);
    border:1px solid var(--keyBorder);
    border-radius:6px;
    box-shadow:var(--keyShadow);
    min-width:44px;
    height:44px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:800;
    color:#4a4a4a;
    user-select:none;
    position:relative;
  }
  .key.small{min-width:40px}
  .key.wide{min-width:88px}
  .key.wider{min-width:110px}
  .key.space{min-width:340px}
  .key.enter{min-width:96px}
  .key.shift{min-width:120px}
  .key.backspace{min-width:92px}
  .key.hl{
    background:rgba(0, 163, 255, .18);
    border-color:rgba(0, 163, 255, .6);
    box-shadow:0 0 0 3px rgba(0, 163, 255, .18);
  }
  .key.pressed{
    background:rgba(255, 183, 3, .28);
    border-color:rgba(255, 183, 3, .8);
    box-shadow:0 0 0 3px rgba(255, 183, 3, .18);
  }
  .key .sub{
    position:absolute;
    right:6px;
    bottom:4px;
    font-size:10px;
    opacity:.65;
    font-weight:700;
  }

  /* Footer stats (small) */
  .stats{
    display:flex;
    gap:16px;
    justify-content:center;
    margin-top:24px;
    flex-wrap:wrap;
  }
  .stat{
    width:170px;
    background:#fff;
    border:1px solid #e6e6e6;
    border-radius:12px;
    padding:14px 10px;
    box-shadow:0 1px 0 rgba(0,0,0,.05);
  }
  .stat .k{color:#666;font-weight:800;font-size:14px}
  .stat .v{margin-top:6px;font-weight:900;font-size:26px}
  .hiddenInput{
    position:absolute;
    left:-9999px;
    top:-9999px;
    opacity:0;
    width:1px;height:1px;
  }
</style>
</head>
<body>
  <div class="topbar">
    <div class="title">タイピング練習　日本語入力</div>
    <div class="right">
      <div class="timerWrap">
        <div class="timerLabel">残り時間</div>
        <div class="progress" aria-hidden="true"><div id="bar"></div></div>
        <div class="timeText"><span id="mm">5</span>分 <span id="ss">00</span>秒</div>
      </div>
      <button class="endBtn" id="btnEnd" type="button"><span class="endIcon">×</span> 終了する</button>
    </div>
  </div>

  <div class="wrap">
    <div class="center">
      <div class="countBadge" aria-label="入力文字数">
        <div class="label">入力文字数</div>
        <div class="val" id="charCount">0</div>
      </div>

      <div id="idleView">
        <div class="hint">スペースキーを押して開始します。</div>
        <div class="subhint">（日本語入力モードはOFFにして下さい。）</div>
      </div>

      <div id="taskView" style="display:none">
        <div class="jp" id="jpText">—</div>
        <div class="divider"></div>
        <div class="kana" id="kanaText">—</div>
        <div class="romaji" id="romajiLine">—</div>
      </div>

      <input class="hiddenInput" id="hiddenInput" autocomplete="off" autocapitalize="off" spellcheck="false" />
      <div class="kbWrap" id="kb"></div>

      <div class="stats">
        <div class="stat"><div class="k">正解</div><div class="v" id="statOk">0</div></div>
        <div class="stat"><div class="k">ミス</div><div class="v" id="statMiss">0</div></div>
        <div class="stat"><div class="k">正確率</div><div class="v" id="statAcc">—</div></div>
        <div class="stat"><div class="k">連続正解</div><div class="v" id="statStreak">0</div></div>
        <div class="stat"><div class="k">速度</div><div class="v" id="statSpd">—</div></div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ===== Utilities =====
  const $ = (id)=>document.getElementById(id);

  const STATE = { IDLE:"idle", RUN:"run", DONE:"done" };
  let state = STATE.IDLE;

  const SESSION = {
    totalSec: 5*60,
    leftSec: 5*60,
    timerId: null,
    startedAt: 0,
    startedTypingAt: 0,
    ok: 0,
    miss: 0,
    streak: 0,
    bestStreak: 0,
    charCount: 0,
    current: null, // {jp,kana,romaji}
    typed: "",
    mismatch: false, // current typed mismatch flag
    order: [],
    orderIdx: 0,
  };

  // ` は無効（誤操作防止）
  function isBackquoteKey(e){
    return e.code === "Backquote" || e.key === "`";
  }

  // 長音（ー/ｰ）は 半角ハイフン扱い
  function normalizeTarget(s){
    return String(s)
      .replace(/[ーｰ]/g, "-")
      .replace(/\s+/g, " ")
      .trim();
  }

  // ===== Romaji (kana -> romaji) =====
  // 「ぁ/ぃ/ぅ/ぇ/ぉ」= la/li/lu/le/lo に統一済み
  const KANA_MAP = {
    "ぁ":"la","ぃ":"li","ぅ":"lu","ぇ":"le","ぉ":"lo",
    "あ":"a","い":"i","う":"u","え":"e","お":"o",
    "か":"ka","き":"ki","く":"ku","け":"ke","こ":"ko",
    "さ":"sa","し":"shi","す":"su","せ":"se","そ":"so",
    "た":"ta","ち":"chi","つ":"tsu","て":"te","と":"to",
    "な":"na","に":"ni","ぬ":"nu","ね":"ne","の":"no",
    "は":"ha","ひ":"hi","ふ":"fu","へ":"he","ほ":"ho",
    "ま":"ma","み":"mi","む":"mu","め":"me","も":"mo",
    "や":"ya","ゆ":"yu","よ":"yo",
    "ら":"ra","り":"ri","る":"ru","れ":"re","ろ":"ro",
    "わ":"wa","を":"wo","ん":"n",
    "が":"ga","ぎ":"gi","ぐ":"gu","げ":"ge","ご":"go",
    "ざ":"za","じ":"ji","ず":"zu","ぜ":"ze","ぞ":"zo",
    "だ":"da","ぢ":"ji","づ":"zu","で":"de","ど":"do",
    "ば":"ba","び":"bi","ぶ":"bu","べ":"be","ぼ":"bo",
    "ぱ":"pa","ぴ":"pi","ぷ":"pu","ぺ":"pe","ぽ":"po",
    "きゃ":"kya","きゅ":"kyu","きょ":"kyo",
    "しゃ":"sha","しゅ":"shu","しょ":"sho",
    "ちゃ":"cha","ちゅ":"chu","ちょ":"cho",
    "にゃ":"nya","にゅ":"nyu","にょ":"nyo",
    "ひゃ":"hya","ひゅ":"hyu","ひょ":"hyo",
    "みゃ":"mya","みゅ":"myu","みょ":"myo",
    "りゃ":"rya","りゅ":"ryu","りょ":"ryo",
    "ぎゃ":"gya","ぎゅ":"gyu","ぎょ":"gyo",
    "じゃ":"ja","じゅ":"ju","じょ":"jo",
    "びゃ":"bya","びゅ":"byu","びょ":"byo",
    "ぴゃ":"pya","ぴゅ":"pyu","ぴょ":"pyo",
    "ふぁ":"fa","ふぃ":"fi","ふぇ":"fe","ふぉ":"fo",
    "ゔぁ":"va","ゔぃ":"vi","ゔ":"vu","ゔぇ":"ve","ゔぉ":"vo",
    "ゃ":"lya","ゅ":"lyu","ょ":"lyo",
    "っ":"", // handled separately
    "ー":"-","ｰ":"-",
    "、":",","。":".","，":",","．":".","・":"/","／":"/",
    "「":"","」":"","『":"","』":"","（":"", "）":"", "(": "", ")":"",
    "　":" "," ":" "
  };

  function toHira(s){
    return String(s).replace(/[ァ-ヶ]/g, ch => String.fromCharCode(ch.charCodeAt(0)-0x60))
                    .replace(/ヴ/g,"ゔ");
  }

  function kanaToRomaji(kana){
    kana = toHira(kana);
    let out = "";
    for(let i=0;i<kana.length;i++){
      const two = kana.slice(i, i+2);
      if(KANA_MAP[two]){
        out += KANA_MAP[two];
        i++;
        continue;
      }
      const ch = kana[i];
      if(ch === "っ"){
        // small tsu: double next consonant
        const next2 = kana.slice(i+1, i+3);
        const next1 = kana[i+1] ?? "";
        let nextRoma = KANA_MAP[next2] || KANA_MAP[next1] || "";
        if(nextRoma){
          out += nextRoma[0];
        }
        continue;
      }
      if(ch === "ん"){
        // 'n' before vowel/y
        const next2 = kana.slice(i+1, i+3);
        const next1 = kana[i+1] ?? "";
        let nextRoma = KANA_MAP[next2] || KANA_MAP[next1] || "";
        if(nextRoma && /^[aiueoy]/.test(nextRoma)){
          out += "n'";
        }else{
          out += "n";
        }
        continue;
      }
      out += (KANA_MAP[ch] ?? ch);
    }
    // normalize spaces and long vowel already done
    out = out.replace(/\s+/g," ").trim();
    return out;
  }

  // ===== Phrase bank (約1000) =====
  // 1) 手作業（漢字+よみ）: 例として自然な文章を優先
  const BASE = [
    {jp:"瀬戸大橋に行ってきました。", kana:"せとおおはしにいってきました。"},
    {jp:"環境保護は重要だ。", kana:"かんきょうほごはじゅうようだ。"},
    {jp:"帰ってきたら、手を洗おう。", kana:"かえってきたら、てをあらおう。"},
    {jp:"朝ごはんを食べてから出発します。", kana:"あさごはんをたべてからしゅっぱつします。"},
    {jp:"電車が遅れて困りました。", kana:"でんしゃがおくれてこまりました。"},
    {jp:"今日は天気がいいですね。", kana:"きょうはてんきがいいですね。"},
    {jp:"忘れ物をしないように。", kana:"わすれものをしないように。"},
    {jp:"水分補給を忘れずに。", kana:"すいぶんほきゅうをわすれずに。"},
    {jp:"静かにしてください。", kana:"しずかにしてください。"},
    {jp:"安全第一で行動しよう。", kana:"あんぜんだいいちでこうどうしよう。"},
    {jp:"時間に余裕を持とう。", kana:"じかんによゆうをもとう。"},
    {jp:"エコバッグを持っていこう。", kana:"えこばっぐをもっていこう。"},
    {jp:"ゴミは分別して捨てる。", kana:"ごみはぶんべつしてすてる。"},
    {jp:"ハードディスクが壊れました。", kana:"はーどでぃすくがこわれました。"},
    {jp:"パスワードは定期的に変えよう。", kana:"ぱすわーどはていきてきにかえよう。"},
    {jp:"深呼吸して落ち着こう。", kana:"しんこきゅうしておちつこう。"},
    {jp:"困ったら相談してください。", kana:"こまったらそうだんしてください。"},
    {jp:"無理をしないで休もう。", kana:"むりをしないでやすもう。"},
    {jp:"小さな積み重ねが大切だ。", kana:"ちいさなつみかさねがたいせつだ。"},
  ];

  // 2) 自然なひらがな短文をテンプレで生成して1000に増やす（読み不要）
  // ※ 全角入力禁止でも打てるよう、句読点は「、。」(= , . に変換)のみを使う
  const PLACES = ["こうえん","えき","がっこう","としょかん","すーぱー","びょういん","きっさてん","しょくば","いえ","まち","うみ","やま","かわ"];
  const TIMES  = ["きょう","あした","きのう","こんしゅう","らいしゅう","いま","さっき","あさ","ひる","よる"];
  const WEATHER = ["はれ","くもり","あめ","ゆき","かぜがつよい","さむい","あつい"];
  const ACTIONS_PAST = ["さんぽしました","うんどうしました","べんきょうしました","かいものしました","そうじしました","りょうりしました","れんしゅうしました","きゅうけいしました","しゅくだいをしました","でんわしました"];
  const ACTIONS_NOW  = ["さんぽします","うんどうします","べんきょうします","かいものします","そうじします","りょうりします","れんしゅうします","きゅうけいします","しゅくだいをします","でんわします"];
  const EVENTS  = ["でんしゃがおくれました","ばすがこみました","みちにまよいました","つかれました","ねむいです","おなかがすきました","じかんがありません","わすれものをしました","ぱそこんがこわれました","すまほをなくしました"];
  const REQUESTS = ["しずかにしてください","ゆっくりはなしてください","もういちどいってください","ちょっとまってください","きをつけてください","てつだってください"];
  const ADVICE = ["てをあらおう","みずをのもう","はやくねよう","あさごはんをたべよう","まどをあけてかんきしよう","でんきをこまめにけそう","ごみをぶんべつしよう","すいぶんほきゅうをわすれずに"];
  const TOPICS = ["かんきょうほご","けんこう","あんぜん","べんきょう","しごと","そうじ","せいかつ","こうつう","じかん","れんしゅう"];
  const STATEMENTS = ["たいせつだ","じゅうようだ","ひつようだ","だいじだ","むずかしい","かんたんだ","たのしい"];

  const PHRASES = [];
  const used = new Set();

  function addPhrase(jp, kana){
    // kana未指定なら同じ
    kana = kana ?? jp;
    const key = `${jp}__${kana}`;
    if(used.has(key)) return false;
    used.add(key);
    PHRASES.push({jp, kana, romaji:kanaToRomaji(kana)});
    return true;
  }

  // base first
  for(const b of BASE){
    addPhrase(b.jp, b.kana);
  }

  // templates (ひらがな中心)
  const TEMPLATES = [
    () => `${PLACES[rPick(PLACES)]}にいってきました。`,
    () => `${PLACES[rPick(PLACES)]}で${ACTIONS_PAST[rPick(ACTIONS_PAST)]}。`,
    () => `${TIMES[rPick(TIMES)]}は${WEATHER[rPick(WEATHER)]}です。`,
    () => `${EVENTS[rPick(EVENTS)]}。`,
    () => `${REQUESTS[rPick(REQUESTS)]}。`,
    () => `${ADVICE[rPick(ADVICE)]}。`,
    () => `かえってきたら、${ADVICE[rPick(ADVICE)]}。`,
    () => `わすれものをしないように。`,
    () => `じかんによゆうをもとう。`,
    () => `むりをしないでやすもう。`,
    () => `${TOPICS[rPick(TOPICS)]}は${STATEMENTS[rPick(STATEMENTS)]}。`,
    () => `きょうは${PLACES[rPick(PLACES)]}へいきます。`,
    () => `あしたは${PLACES[rPick(PLACES)]}へいこう。`,
    () => `さっき${PLACES[rPick(PLACES)]}であいました。`,
    () => `いまから${ACTIONS_NOW[rPick(ACTIONS_NOW)]}。`,
    () => `すこしきゅうけいしよう。`,
    () => `ゆっくりいきましょう。`,
    () => `ていねいにやろう。`,
    () => `あんぜんをかくにんしよう。`,
    () => `すまほのじゅうでんをわすれずに。`,
  ];

  // deterministic-ish pick for variety but still "random"
  let seed = 123456789;
  function rnd(){
    seed = (seed * 1664525 + 1013904223) >>> 0;
    return seed / 4294967296;
  }
  function rPick(arr){
    return Math.floor(rnd() * arr.length);
  }

  // fill up to ~1000 with unique sentences
  let guard = 0;
  while(PHRASES.length < 1000 && guard < 200000){
    guard++;
    const maker = TEMPLATES[rPick(TEMPLATES)];
    const jp = maker();
    // ひらがな生成は読み不要なので kana=jp
    addPhrase(jp, jp);
  }
  // fallback: if something went wrong, keep at least base
  if(PHRASES.length < BASE.length) {
    PHRASES.length = 0;
    for(const b of BASE) PHRASES.push({jp:b.jp, kana:b.kana, romaji:kanaToRomaji(b.kana)});
  }

  // ===== Order / no repeat until full cycle =====

  function makeOrder(){
    SESSION.order = Array.from({length:PHRASES.length}, (_,i)=>i);
    // shuffle
    for(let i=SESSION.order.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [SESSION.order[i], SESSION.order[j]] = [SESSION.order[j], SESSION.order[i]];
    }
    SESSION.orderIdx = 0;
  }
  makeOrder();

  function nextItem(){
    if(SESSION.orderIdx >= SESSION.order.length){
      const last = SESSION.current ? SESSION.current.jp : null;
      makeOrder();
      // avoid immediate repeat at cycle boundary
      if(last && PHRASES[SESSION.order[0]].jp === last && SESSION.order.length>1){
        [SESSION.order[0], SESSION.order[1]] = [SESSION.order[1], SESSION.order[0]];
      }
    }
    const idx = SESSION.order[SESSION.orderIdx++];
    return PHRASES[idx];
  }

  // ===== Virtual keyboard (JIS-ish minimal) =====
  const KB_ROWS = [
    // row1
    [
      {code:"Digit1", label:"1"}, {code:"Digit2", label:"2"}, {code:"Digit3", label:"3"}, {code:"Digit4", label:"4"},
      {code:"Digit5", label:"5"}, {code:"Digit6", label:"6"}, {code:"Digit7", label:"7"}, {code:"Digit8", label:"8"},
      {code:"Digit9", label:"9"}, {code:"Digit0", label:"0"},
      {code:"Minus", label:"-"},
      {code:"Equal", label:"^"},
      {code:"IntlYen", label:"¥"},
      {code:"Backspace", label:"Back", cls:"backspace wide"}
    ],
    // row2
    [
      {code:"KeyQ", label:"Q"}, {code:"KeyW", label:"W"}, {code:"KeyE", label:"E"}, {code:"KeyR", label:"R"},
      {code:"KeyT", label:"T"}, {code:"KeyY", label:"Y"}, {code:"KeyU", label:"U"}, {code:"KeyI", label:"I"},
      {code:"KeyO", label:"O"}, {code:"KeyP", label:"P"},
      {code:"BracketLeft", label:"@"},
      {code:"BracketRight", label:"["},
      {code:"Enter", label:"Enter", cls:"enter"}
    ],
    // row3
    [
      {code:"KeyA", label:"A"}, {code:"KeyS", label:"S"}, {code:"KeyD", label:"D"}, {code:"KeyF", label:"F"},
      {code:"KeyG", label:"G"}, {code:"KeyH", label:"H"}, {code:"KeyJ", label:"J"}, {code:"KeyK", label:"K"},
      {code:"KeyL", label:"L"},
      {code:"Semicolon", label:";"},
      {code:"Quote", label:":"}, // JISでは : がこのへん。簡略表示
      {code:"Backslash", label:"]"} // 簡略（この記号はほぼ出ないので保険）
    ],
    // row4
    [
      {code:"ShiftLeft", label:"Shift", cls:"shift"},
      {code:"KeyZ", label:"Z"}, {code:"KeyX", label:"X"}, {code:"KeyC", label:"C"}, {code:"KeyV", label:"V"},
      {code:"KeyB", label:"B"}, {code:"KeyN", label:"N"}, {code:"KeyM", label:"M"},
      {code:"Comma", label:","}, {code:"Period", label:"."}, {code:"Slash", label:"/"},
      {code:"IntlRo", label:"\\"},
      {code:"ShiftRight", label:"Shift", cls:"shift"}
    ],
    // row5
    [
      {code:"Space", label:"", cls:"space"}
    ]
  ];

  const keyElsByCode = new Map();
  function renderKeyboard(){
    const kb = $("kb");
    kb.innerHTML = "";
    KB_ROWS.forEach(row => {
      const rowEl = document.createElement("div");
      rowEl.className = "row";
      row.forEach(k => {
        const el = document.createElement("div");
        el.className = "key " + (k.cls || "");
        el.dataset.code = k.code;
        if(k.code === "Space"){
          el.innerHTML = "<span class='sub'>Space</span>";
        }else{
          el.textContent = k.label;
        }
        rowEl.appendChild(el);
        keyElsByCode.set(k.code, el);
      });
      kb.appendChild(rowEl);
    });
  }
  renderKeyboard();

  function clearHL(){
    for(const el of keyElsByCode.values()){
      el.classList.remove("hl");
    }
  }
  function clearPressed(){
    for(const el of keyElsByCode.values()){
      el.classList.remove("pressed");
    }
  }

  // Map next character -> KeyboardEvent.code (JIS minimal)
  function charToCode(ch){
    if(!ch) return null;
    if(ch === " ") return "Space";
    const c = ch.toLowerCase();
    if(c >= "a" && c <= "z") return "Key" + c.toUpperCase();
    if(c >= "0" && c <= "9") return "Digit" + c;
    const map = {
      "-":"Minus",
      "^":"Equal",
      "¥":"IntlYen","\\":"IntlRo",
      ",":"Comma",".":"Period","/":"Slash",
      ";":"Semicolon",":":"Quote",
      "@":"BracketLeft","[":"BracketRight",
      "]":"Backslash",
      "'":"Quote",
      "_":"IntlRo",
      "!":"Digit1",
      "?":"Slash",
      ".":"Period",
    };
    return map[ch] || map[c] || null;
  }

  function highlightNextKey(){
    clearHL();
    if(state === STATE.IDLE){
      const el = keyElsByCode.get("Space");
      if(el) el.classList.add("hl");
      return;
    }
    if(!SESSION.current) return;
    const target = SESSION.current.romajiNorm;
    const pos = SESSION.typed.length;
    const next = target[pos] || "";
    const code = charToCode(next);
    if(code){
      const el = keyElsByCode.get(code);
      if(el) el.classList.add("hl");
    }
  }

  function pressFlashByCode(code){
    if(!code) return;
    const el = keyElsByCode.get(code);
    if(!el) return;
    el.classList.add("pressed");
    setTimeout(()=>el.classList.remove("pressed"), 120);
  }

  // ===== Problem / render =====
  function setProblem(item){
    SESSION.current = {
      jp: item.jp,
      kana: item.kana,
      romaji: item.romaji,
      romajiNorm: normalizeTarget(item.romaji).toLowerCase()
    };
    SESSION.typed = "";
    SESSION.mismatch = false;
    $("jpText").textContent = item.jp;
    $("kanaText").textContent = toHira(item.kana);
    renderRomajiLine();
    highlightNextKey();
  }

  function renderRomajiLine(){
    const target = SESSION.current ? SESSION.current.romajiNorm : "";
    const typed = SESSION.typed;
    let html = "";
    for(let i=0;i<target.length;i++){
      const ch = target[i].toUpperCase();
      if(i < typed.length){
        const ok = typed[i] === target[i];
        html += `<span class="${ok ? "typedGood":"typedBad"}">${escapeHtml(ch)}</span>`;
      }else{
        html += `<span class="rest">${escapeHtml(ch)}</span>`;
      }
    }
    $("romajiLine").innerHTML = html || "—";
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // ===== Timer =====
  function updateTimerUI(){
    const mm = Math.floor(SESSION.leftSec / 60);
    const ss = SESSION.leftSec % 60;
    $("mm").textContent = String(mm);
    $("ss").textContent = String(ss).padStart(2,"0");
    const ratio = Math.max(0, Math.min(1, SESSION.leftSec / SESSION.totalSec));
    $("bar").style.transform = `scaleX(${ratio})`;
  }

  function startTimer(){
    if(SESSION.timerId) return;
    SESSION.startedAt = Date.now();
    SESSION.leftSec = SESSION.totalSec;
    updateTimerUI();
    SESSION.timerId = setInterval(() => {
      const elapsed = Math.floor((Date.now() - SESSION.startedAt)/1000);
      SESSION.leftSec = Math.max(0, SESSION.totalSec - elapsed);
      updateTimerUI();
      if(SESSION.leftSec <= 0){
        finish();
      }else{
        updateSpeed();
      }
    }, 200);
  }

  function finish(){
    if(state === STATE.DONE) return;
    state = STATE.DONE;
    if(SESSION.timerId){ clearInterval(SESSION.timerId); SESSION.timerId=null; }
    // show idle message with result summary
    $("taskView").style.display = "none";
    $("idleView").style.display = "";
    $("idleView").innerHTML = `<div class="hint">終了しました。</div>
      <div class="subhint">もう一度やるには、スペースキーを押してください。</div>`;
    highlightNextKey();
  }

  function resetAll(){
    if(SESSION.timerId){ clearInterval(SESSION.timerId); SESSION.timerId=null; }
    state = STATE.IDLE;
    SESSION.leftSec = SESSION.totalSec;
    SESSION.startedAt = 0;
    SESSION.startedTypingAt = 0;
    SESSION.ok = 0;
    SESSION.miss = 0;
    SESSION.streak = 0;
    SESSION.bestStreak = 0;
    SESSION.charCount = 0;
    $("charCount").textContent = "0";
    $("statOk").textContent = "0";
    $("statMiss").textContent = "0";
    $("statAcc").textContent = "—";
    $("statStreak").textContent = "0";
    $("statSpd").textContent = "—";
    updateTimerUI();
    $("idleView").style.display = "";
    $("idleView").innerHTML = `<div class="hint">スペースキーを押して開始します。</div>
      <div class="subhint">（日本語入力モードはOFFにして下さい。）</div>`;
    $("taskView").style.display = "none";
    setProblem(nextItem()); // prepare next
    highlightNextKey();
  }

  // ===== Scoring / speed =====
  function updateAcc(){
    const total = SESSION.ok + SESSION.miss;
    if(total === 0) { $("statAcc").textContent = "—"; return; }
    const acc = Math.round((SESSION.ok / total) * 100);
    $("statAcc").textContent = acc + "%";
  }
  function updateSpeed(){
    // chars per minute based on typed characters (romaji) since start typing
    if(!SESSION.startedTypingAt){ $("statSpd").textContent = "—"; return; }
    const elapsedMin = (Date.now() - SESSION.startedTypingAt) / 60000;
    if(elapsedMin <= 0){ $("statSpd").textContent = "—"; return; }
    const cpm = Math.round(SESSION.charCount / elapsedMin);
    $("statSpd").textContent = cpm + " cpm";
  }

  function onCorrect(){
    SESSION.ok += 1;
    SESSION.streak += 1;
    SESSION.bestStreak = Math.max(SESSION.bestStreak, SESSION.streak);
    $("statOk").textContent = String(SESSION.ok);
    $("statStreak").textContent = `${SESSION.streak}`;
    updateAcc();
    // next
    setProblem(nextItem());
  }

  function onMiss(){
    SESSION.miss += 1;
    SESSION.streak = 0;
    $("statMiss").textContent = String(SESSION.miss);
    $("statStreak").textContent = "0";
    updateAcc();
  }

  // ===== Input handling (manual buffer; avoids IME double input) =====
  function ensureRunningStart(){
    if(state === STATE.IDLE || state === STATE.DONE){
      state = STATE.RUN;
      $("idleView").style.display = "none";
      $("taskView").style.display = "";
      if(!SESSION.current) setProblem(nextItem());
      startTimer();
      // first actual typing moment
      if(!SESSION.startedTypingAt) SESSION.startedTypingAt = Date.now();
      highlightNextKey();
    }
  }

  function handleCharInput(ch){
    if(state !== STATE.RUN) return;
    const target = SESSION.current.romajiNorm;
    const pos = SESSION.typed.length;
    if(pos >= target.length) return;

    // normalize long vowel input too
    if(ch === "ー" || ch === "ｰ") ch = "-";

    // accept only ascii printable and space, comma, period, slash, hyphen, apostrophe
    if(ch.length !== 1) return;
    const code = ch.charCodeAt(0);
    if(!(code === 32 || (code >= 33 && code <= 126))) return;

    // letters: force lowercase for compare
    const add = (/[A-Za-z]/.test(ch)) ? ch.toLowerCase() : ch;

    // update pressed flash based on char
    pressFlashByCode(charToCode(add));

    // apply
    SESSION.typed += add;
    SESSION.charCount += 1;
    $("charCount").textContent = String(SESSION.charCount);

    // mismatch detection (only count miss once per problem, like many typing games)
    if(add !== target[pos]){
      if(!SESSION.mismatch){
        SESSION.mismatch = true;
        onMiss();
      }
    }

    renderRomajiLine();
    highlightNextKey();
    updateSpeed();

    if(SESSION.typed.length === target.length){
      if(!SESSION.mismatch){
        onCorrect();
      }else{
        // mismatch: still move on when fully typed (to keep flow)
        setProblem(nextItem());
      }
    }
  }

  function handleBackspace(){
    if(state !== STATE.RUN) return;
    if(SESSION.typed.length === 0) return;
    SESSION.typed = SESSION.typed.slice(0, -1);
    renderRomajiLine();
    highlightNextKey();
  }

  window.addEventListener("keydown", (e) => {
    // disable backquote
    if(isBackquoteKey(e)){
      e.preventDefault();
      return;
    }

    // Start with Space (idle/done)
    if((state === STATE.IDLE || state === STATE.DONE) && e.code === "Space"){
      e.preventDefault();
      resetAll();
      ensureRunningStart();
      return;
    }

    if(state !== STATE.RUN){
      // ignore other keys
      highlightNextKey();
      return;
    }

    // prevent default for control keys to avoid scrolling etc
    if(e.code === "Space") e.preventDefault();

    if(e.code === "Backspace"){
      e.preventDefault();
      pressFlashByCode("Backspace");
      handleBackspace();
      return;
    }
    if(e.code === "Enter"){
      // Enter is ignored (Benesse-like)
      e.preventDefault();
      pressFlashByCode("Enter");
      return;
    }

    // Ignore IME "Process"
    if(e.key === "Process" || e.isComposing) return;

    // Append printable key
    if(e.key && e.key.length === 1){
      handleCharInput(e.key);
    }
  }, {passive:false});

  $("btnEnd").addEventListener("click", () => finish());

  // initial prepare
  setProblem(nextItem());
  updateTimerUI();
  highlightNextKey();

})();
</script>
</body>
</html>
