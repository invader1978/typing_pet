<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<!-- âœ… ã‚ºãƒ¼ãƒ ç„¡åŠ¹ï¼ˆãƒ”ãƒ³ãƒæ‹¡å¤§ç¸®å°ç¦æ­¢ï¼‰ -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>è²·ã„ç‰©ãƒªã‚¹ãƒˆ</title>

<style>
:root{
  --bg:#000;
  --card:#1c1c1e;
  --line:rgba(255,255,255,.08);
  --text:#fff;
  --accent:#ff375f;
  --danger:#ff3b30;
  --radius:24px;
}
*{box-sizing:border-box;}
html,body{
  height:100%;
  /* âœ… iOSã®ã‚¿ãƒƒãƒ—é¸æŠ/é•·æŠ¼ã—ç³»ã‚’æŠ‘åˆ¶ */
  -webkit-text-size-adjust:100%;
}
body{
  margin:0;
  background:var(--bg);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  display:flex;
  justify-content:center;
  color:var(--text);

  /* âœ… é•·æŠ¼ã—ã§é¸æŠãŒå‡ºãªã„ã‚ˆã†ã« */
  -webkit-user-select:none;
  user-select:none;

  /* âœ… 300msã‚¿ãƒƒãƒ—é…å»¶/ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ ç­‰ã®å‰¯ä½œç”¨æ¸› */
  touch-action:manipulation;
}
button, input, .row, .card{
  -webkit-user-select:none;
  user-select:none;
}

/* âœ… PCã§ã‚‚ã‚¹ãƒãƒ›è¦‹ãŸç›®å›ºå®š */
.phone{
  width:390px;
  min-height:100vh;
  padding:14px;
}

/* ===== Top ===== */
.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:14px;
}
.top-left,.top-right{
  display:flex;
  gap:12px;
  align-items:center;
}
.title{
  font-weight:900;
  font-size:20px;
  letter-spacing:.02em;
}

/* âœ… ãƒœã‚¿ãƒ³ã‚’å¤§ãã */
.iconbtn{
  border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.10);
  color:var(--accent);
  padding:12px 18px;         /* â† å¤§ãã */
  font-weight:800;
  font-size:18px;            /* â† å¤§ãã */
  min-height:52px;           /* â† å¤§ãã */
}
.editbtn{
  border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.10);
  color:var(--accent);
  padding:12px 18px;         /* â† å¤§ãã */
  font-weight:900;
  font-size:18px;            /* â† å¤§ãã */
  min-height:52px;           /* â† å¤§ãã */
}

/* ===== Card ===== */
.card{
  background:var(--card);
  border-radius:var(--radius);
  overflow:hidden;
}

/* ===== Swipe ===== */
.swipe-wrap{ position:relative; overflow:hidden; }
.actions{
  position:absolute;
  top:0; right:0; bottom:0;
  display:flex;
}
.actions button{
  width:98px;                /* å°‘ã—å¤§ãã‚ */
  border:none;
  background:var(--danger);
  color:#fff;
  font-weight:900;
  font-size:16px;
}

/* ===== Row ===== */
.row{
  display:flex;
  align-items:center;
  gap:12px;
  padding:18px 16px;
  border-bottom:1px solid var(--line);
  background:var(--card);
  transition:transform .18s ease;
  /* âœ… é•·æŠ¼ã—åå¿œã‚’æ¸›ã‚‰ã™ */
  -webkit-touch-callout:none;
}
.row:last-child{border-bottom:none;}
.dragging{opacity:.4;}

.del{
  display:none;
  width:30px;height:30px;
  border-radius:999px;
  background:var(--accent);
  color:#fff;
  border:none;
  font-size:18px;
  font-weight:900;
}
.edit .del{display:flex;justify-content:center;align-items:center;}

.cb{
  width:26px;height:26px;     /* å°‘ã—å¤§ãã */
}
.edit .cb{opacity:.25;pointer-events:none;}

.text{
  flex:1;
  font-size:18px;
  line-height:1.2;
}
.checked{text-decoration:line-through;opacity:.5;}

.handle{
  display:none;
  font-size:24px;            /* å°‘ã—å¤§ãã */
  cursor:grab;
  padding:6px 8px;
  border-radius:10px;
  color:rgba(255,255,255,.6);
}
.edit .handle{display:block;}

/* ===== Add ===== */
.bottom{margin-top:14px;}
.plus{
  width:60px;height:60px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.10);
  font-size:30px;
  color:#fff;
}
.inputwrap{display:none;margin-top:10px;}
.inputwrap.show{display:block;}
.input{
  width:100%;
  height:56px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.10);
  color:#fff;
  padding:0 14px;
  font-size:16px;

  /* âœ… å…¥åŠ›æ¬„ã ã‘ã¯é¸æŠã§ãã‚‹ã‚ˆã†ã«æˆ»ã™ */
  -webkit-user-select:text;
  user-select:text;
}
</style>
</head>

<body>
<div class="phone" id="app">

  <div class="topbar">
    <div class="top-left">
      <button class="iconbtn" id="trashBtn" aria-label="å…¨å‰Šé™¤">ğŸ—‘</button>
      <button class="editbtn" id="editBtn" aria-label="ç·¨é›†">ç·¨é›†</button>
    </div>
    <div class="title">ãƒªã‚¹ãƒˆ</div>
    <div class="top-right">
      <button class="iconbtn" id="shareBtn" aria-label="å…±æœ‰">å…±æœ‰</button>
    </div>
  </div>

  <div class="card" id="list"></div>

  <div class="bottom">
    <button class="plus" id="plusBtn" aria-label="è¿½åŠ ">ï¼‹</button>
    <div class="inputwrap" id="inputWrap">
      <input class="input" id="newText" placeholder="è²·ã†ã‚‚ã®ã‚’å…¥åŠ›â€¦" />
    </div>
  </div>

</div>

<script>
/* âœ… iOSã®é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼/ç”»åƒä¿å­˜ãªã©ã‚’æŠ‘åˆ¶ï¼ˆå®‰å…¨å´ï¼‰ */
document.addEventListener("contextmenu", (e) => e.preventDefault(), { passive:false });

/* âœ… ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ æŠ‘åˆ¶ï¼ˆiOSã§ viewport ã ã‘ã ã¨åŠ¹ã‹ãªã„å ´åˆã®ä¿é™ºï¼‰
   iOS Safariã¯ gesturestart ãŒåŠ¹ãã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ */
document.addEventListener("gesturestart", (e) => e.preventDefault(), { passive:false });
document.addEventListener("gesturechange", (e) => e.preventDefault(), { passive:false });
document.addEventListener("gestureend", (e) => e.preventDefault(), { passive:false });

const KEY="shopping_list_stable_v3";
let items=[];
let editMode=false;
let openId=null;
let dragEl=null;

load();
render();

/* ===== Header ===== */
editBtn.onclick=()=>{
  editMode=!editMode;
  app.classList.toggle("edit",editMode);
  editBtn.textContent=editMode?"âœ“":"ç·¨é›†";
  openId=null;
  render();
};

trashBtn.onclick=()=>{
  if(confirm("å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
    items=[];save();render();
  }
};

/* ===== Share ===== */
shareBtn.onclick=async()=>{
  const text=items.map(i=>`${i.done?"â˜‘":"â˜"} ${i.text}`).join("\n");
  try{
    if(navigator.share){
      await navigator.share({ title:"è²·ã„ç‰©ãƒªã‚¹ãƒˆ", text });
    }else{
      await navigator.clipboard.writeText(text);
      alert("ãƒªã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
    }
  }catch(e){
    // shareã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸç­‰ã¯ä½•ã‚‚ã—ãªã„
  }
};

/* ===== Add ===== */
plusBtn.onclick=()=>{
  if(!inputWrap.classList.contains("show")){
    inputWrap.classList.add("show");
    newText.focus();
  }else commitAdd();
};
newText.onkeydown=e=>{
  if(e.key==="Enter")commitAdd();
  if(e.key==="Escape"){ inputWrap.classList.remove("show"); newText.value=""; }
};
function commitAdd(){
  const text=newText.value.trim();
  if(!text)return;
  items.push({id:crypto.randomUUID(),text,done:false});
  newText.value="";
  save();render();
}

/* ===== Data ===== */
function toggle(id,val){
  if(editMode) return; // ç·¨é›†ä¸­ã¯ãƒã‚§ãƒƒã‚¯ä¸å¯
  const it=items.find(i=>i.id===id);
  if(it){it.done=val;save();render();}
}
function removeOne(id){
  items=items.filter(i=>i.id!==id);
  save();render();
}
function save(){localStorage.setItem(KEY,JSON.stringify(items));}
function load(){
  try{
    const raw=localStorage.getItem(KEY);
    items=raw?JSON.parse(raw):[
      {id:crypto.randomUUID(), text:"ç´è±†", done:false},
      {id:crypto.randomUUID(), text:"é£Ÿãƒ‘ãƒ³ 5æš", done:false},
      {id:crypto.randomUUID(), text:"åµ", done:false},
    ];
    if(!Array.isArray(items)) items=[];
  }catch{ items=[]; }
}

/* ===== Render ===== */
function render(){
  list.innerHTML="";
  items.forEach(it=>{
    const wrap=document.createElement("div");
    wrap.className="swipe-wrap";
    wrap.dataset.id=it.id;

    const actions=document.createElement("div");
    actions.className="actions";
    const delBtn=document.createElement("button");
    delBtn.textContent="å‰Šé™¤";
    delBtn.onclick=()=>removeOne(it.id);
    actions.appendChild(delBtn);

    const row=document.createElement("div");
    row.className="row";
    row.style.transform=(!editMode&&openId===it.id)?"translateX(-98px)":"translateX(0)";

    const del=document.createElement("button");
    del.className="del";
    del.textContent="âˆ’";
    del.onclick=()=>removeOne(it.id);
    row.appendChild(del);

    const cb=document.createElement("input");
    cb.type="checkbox";
    cb.className="cb";
    cb.checked=it.done;
    cb.onchange=()=>toggle(it.id,cb.checked);
    row.appendChild(cb);

    const text=document.createElement("div");
    text.className="text"+(it.done?" checked":"");
    text.textContent=it.text;
    row.appendChild(text);

    const handle=document.createElement("div");
    handle.className="handle";
    handle.textContent="â‰¡";
    handle.onpointerdown=(e)=>startDrag(e,wrap);
    row.appendChild(handle);

    attachSwipe(row,it.id);

    wrap.appendChild(actions);
    wrap.appendChild(row);
    list.appendChild(wrap);
  });
}

/* ===== Swipeï¼ˆãƒã‚§ãƒƒã‚¯å¦¨å®³ãªã—ï¼‰ ===== */
function attachSwipe(row,id){
  let startX=0,startY=0,swiping=false,currentX=0;
  const isInteractive=t=>!!t.closest("input,button,.handle");

  row.onpointerdown=e=>{
    if(editMode||isInteractive(e.target))return;
    startX=e.clientX;
    startY=e.clientY;
    swiping=false;
    row.style.transition="none";
  };

  row.onpointermove=e=>{
    if(editMode||startX===0)return;
    const dx=e.clientX-startX;
    const dy=e.clientY-startY;

    if(!swiping){
      if(Math.abs(dx)<12)return;
      if(Math.abs(dx)<=Math.abs(dy))return;
      swiping=true;
    }
    currentX=Math.min(0,Math.max(-98,dx));
    row.style.transform=`translateX(${currentX}px)`;
  };

  row.onpointerup=()=>{
    if(editMode)return;
    if(!swiping){startX=0;return;}
    row.style.transition="transform .18s ease";
    openId=(currentX<=-49)?id:null;
    startX=0;
    render();
  };
}

/* ===== Drag Reorderï¼ˆç·¨é›†æ™‚ã€â‰¡ã§ãƒ‰ãƒ©ãƒƒã‚°ï¼‰ ===== */
function startDrag(e,wrap){
  if(!editMode) return;
  dragEl=wrap;
  wrap.querySelector(".row").classList.add("dragging");

  const move=(ev)=>{
    const after=getAfter(ev.clientY);
    if(after==null) list.appendChild(dragEl);
    else list.insertBefore(dragEl,after);
  };
  const up=()=>{
    dragEl.querySelector(".row").classList.remove("dragging");
    dragEl=null;
    persist();
    window.removeEventListener("pointermove",move);
    window.removeEventListener("pointerup",up);
    window.removeEventListener("pointercancel",up);
  };
  window.addEventListener("pointermove",move);
  window.addEventListener("pointerup",up);
  window.addEventListener("pointercancel",up);
}

function getAfter(y){
  const els=[...list.querySelectorAll(".swipe-wrap")].filter(w=>w!==dragEl);
  let closest={offset:-Infinity,el:null};
  els.forEach(w=>{
    const box=w.getBoundingClientRect();
    const offset=y-box.top-box.height/2;
    if(offset<0 && offset>closest.offset){
      closest={offset,el:w};
    }
  });
  return closest.el;
}

function persist(){
  const ordered=[...list.querySelectorAll(".swipe-wrap")].map(w=>w.dataset.id);
  const map=new Map(items.map(i=>[i.id,i]));
  items=ordered.map(id=>map.get(id)).filter(Boolean);
  save();
}
</script>
</body>
</html>
