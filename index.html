<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>è²·ã„ç‰©ãƒªã‚¹ãƒˆ</title>

<style>
:root{
  --bg:#000;
  --card:#1c1c1e;
  --line:rgba(255,255,255,.08);
  --text:#fff;
  --sub:rgba(255,255,255,.6);
  --accent:#ff375f;
  --danger:#ff3b30;
  --radius:24px;

  /* å‰Šé™¤ãƒœã‚¿ãƒ³å¹…ï¼ˆCSS/JSã§å…±æœ‰ï¼‰ */
  --actionW: 98px;

  /* iOSã£ã½ã„æˆ»ã‚Šï¼ˆå°‘ã—ãƒãƒæ„Ÿï¼‰ */
  --spring: cubic-bezier(.2,.95,.2,1.1);
}

*{box-sizing:border-box;}
html,body{height:100%; -webkit-text-size-adjust:100%;}

body{
  margin:0;
  background:var(--bg);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
  display:flex;
  justify-content:center;
  color:var(--text);
  -webkit-user-select:none;
  user-select:none;
  touch-action:manipulation;
  overscroll-behavior:none;
}

button, .row{ -webkit-user-select:none; user-select:none; }
input{ -webkit-user-select:text; user-select:text; }

/* âœ… ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼šã‚«ãƒ¼ãƒ‰ã¯å†…å®¹ã‚µã‚¤ã‚ºã€ï¼‹ã¯ä¸‹å¯„ã›ã™ã‚‹ãŒ â€œä¸‹ã’ã™ããªã„â€ */
.phone{
  width:390px;
  min-height:100vh;
  padding:14px;
  display:flex;
  flex-direction:column;
}

/* =======================
   Top Barï¼ˆã‚¿ã‚¤ãƒˆãƒ«å›ºå®šï¼‰
======================= */
.topbar{
  position:relative;
  height:64px;
  margin-bottom:14px;
  flex:0 0 auto;
}
.top-left,
.top-right{
  position:absolute;
  top:0;
  height:100%;
  display:flex;
  align-items:center;
  gap:12px;
  width:150px;
}
.top-left{ left:0; }
.top-right{ right:0; justify-content:flex-end; }

.title{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  font-weight:900;
  font-size:20px;
  pointer-events:none;
}

.iconbtn, .editbtn{
  border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.10);
  color:var(--accent);
  padding:12px 18px;
  font-weight:900;
  font-size:18px;
  min-height:52px;
  transition:transform .12s ease, filter .12s ease;
}
.iconbtn:active, .editbtn:active{
  transform:scale(.97);
  filter:brightness(1.08);
}

/* =======================
   Cardï¼ˆå†…å®¹ã‚µã‚¤ã‚º + ä¸Šé™ã¯JSã§èª¿æ•´ï¼‰
======================= */
.card{
  background:var(--card);
  border-radius:var(--radius);
  overflow:auto;
  -webkit-overflow-scrolling:touch;
  overscroll-behavior:contain;
  flex:0 0 auto; /* âœ… ä¼¸ã³ãªã„ï¼é–“å»¶ã³ã—ãªã„ */
}

.swipe-wrap{ position:relative; overflow:hidden; width:100%; }

.row{ width:100%; position:relative; z-index:2; }
.actions{ z-index:1; }

.actions{
  position:absolute;
  top:0; right:0; bottom:0;
  display:flex;
}
.actions button{
  width:var(--actionW);
  border:none;
  background:var(--danger);
  color:#fff;
  font-weight:900;
  border-top-left-radius:14px;
  border-bottom-left-radius:14px;
  transition:transform .12s ease, filter .12s ease;
}
.actions button:active{
  transform:scale(.98);
  filter:brightness(1.06);
}

/* ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚¹ãƒ¯ã‚¤ãƒ—å‰Šé™¤ã‚’ç„¡åŠ¹åŒ–ï¼ˆâˆ’ã§é–‹ãï¼‰ */
.edit .actions{
  opacity:0;
  pointer-events:none;
}
.edit .swipe-wrap.show-actions .actions{
  opacity:1;
  pointer-events:auto;
}

/* =======================
   Row
======================= */
.row{
  display:flex;
  align-items:center;
  padding:18px 16px;
  border-bottom:1px solid var(--line);
  background:var(--card);
  transition:transform .22s var(--spring), filter .12s ease;
  -webkit-touch-callout:none;

  /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯è¨±å¯ã€æ¨ªã‚¹ãƒ¯ã‚¤ãƒ—ã¯JSã§ç¢ºå®šå¾Œã«æŠ‘åˆ¶ */
  touch-action: pan-y;
}
.row:active{ filter:brightness(1.06); }
.row:last-child{border-bottom:none;}
.dragging{opacity:.35;}

.leftSlot{ width:34px; flex:0 0 34px; display:flex; }
.rightSlot{ width:40px; flex:0 0 40px; display:flex; justify-content:flex-end; }

.del{
  width:30px;height:30px;
  border-radius:999px;
  background:var(--accent);
  color:#fff;
  border:none;
  opacity:0;
  transform:translateX(-12px);
  pointer-events:none;
  transition:opacity .18s ease, transform .18s ease, filter .12s ease;
  display:flex;
  align-items:center;
  justify-content:center;
}
.del:active{ filter:brightness(1.08); transform:translateX(0) scale(.97); }

.edit .del{
  opacity:1;
  transform:translateX(0);
  pointer-events:auto;
}

.cb{
  width:26px;height:26px;
  margin-right:12px;
}
.edit .cb{
  opacity:.25;
  pointer-events:none;
}

.text{
  flex:1;
  font-size:18px;
}
.checked{ text-decoration:line-through; opacity:.5; }

.handle{
  font-size:22px;
  color:var(--sub);
  opacity:0;
  transform:translateX(12px);
  pointer-events:none;
  transition:opacity .18s ease, transform .18s ease;
  touch-action:none;
}
.edit .handle{
  opacity:1;
  transform:translateX(0);
  pointer-events:auto;
}

/* =======================
   Spacerï¼ˆâœ… ï¼‹ã‚’ä¸‹ã«å¯„ã›ã‚‹ãŒ â€œä¸‹ã’ã™ããªã„â€ï¼‰
======================= */
.spacer{
  flex:1 1 auto;
  max-height:80px;  /* âœ… ä¸‹ã’ã™ãé˜²æ­¢ï¼šã“ã“ã§èª¿æ•´ */
}

/* =======================
   Add
======================= */
.bottom{
  flex:0 0 auto;
}
.plus{
  width:60px;height:60px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.10);
  font-size:30px;
  color:#fff;
  transition:transform .12s ease, filter .12s ease;
}
.plus:active{
  transform:scale(.97);
  filter:brightness(1.08);
}
.inputwrap{ display:none; margin-top:10px; }
.inputwrap.show{ display:block; }
.input{
  width:100%;
  height:56px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.10);
  color:#fff;
  padding:0 14px;
}

.del .minus-bar{
  display:block;
  width:14px;
  height:3px;
  background:#fff;
  border-radius:999px;
}
</style>
</head>

<body>
<div class="phone" id="app">

  <div class="topbar">
    <div class="top-left">
      <button class="iconbtn" id="trashBtn" aria-label="å…¨å‰Šé™¤">ğŸ—‘</button>
      <button class="editbtn" id="editBtn" aria-label="ç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ">ç·¨é›†</button>
    </div>

    <div class="title">ãƒªã‚¹ãƒˆ</div>

    <div class="top-right">
      <button class="iconbtn" id="shareBtn" aria-label="å…±æœ‰">å…±æœ‰</button>
    </div>
  </div>

  <div class="card" id="list" role="list" aria-label="è²·ã„ç‰©ãƒªã‚¹ãƒˆ"></div>

  <!-- âœ… ï¼‹ã‚’ä¸‹ã«å¯„ã›ã‚‹ãŒä¸‹ã’ã™ããªã„ãŸã‚ã®ã‚¹ãƒšãƒ¼ã‚µãƒ¼ -->
  <div class="spacer" aria-hidden="true"></div>

  <div class="bottom">
    <button class="plus" id="plusBtn" aria-label="é …ç›®ã‚’è¿½åŠ ">ï¼‹</button>
    <div class="inputwrap" id="inputWrap">
      <input class="input" id="newText" placeholder="è²·ã†ã‚‚ã®ã‚’å…¥åŠ›â€¦" aria-label="è¿½åŠ ã™ã‚‹é …ç›®" />
    </div>
  </div>

</div>

<script>
/* =======================
   Base / Safety
======================= */
document.addEventListener("contextmenu", e=>e.preventDefault(),{passive:false});
document.addEventListener("gesturestart", e=>e.preventDefault(),{passive:false});
document.addEventListener("gesturechange", e=>e.preventDefault(),{passive:false});
document.addEventListener("gestureend", e=>e.preventDefault(),{passive:false});

/* ===== DOM ===== */
const app      = document.getElementById("app");
const list     = document.getElementById("list");
const editBtn  = document.getElementById("editBtn");
const trashBtn = document.getElementById("trashBtn");
const shareBtn = document.getElementById("shareBtn");
const plusBtn  = document.getElementById("plusBtn");
const inputWrap= document.getElementById("inputWrap");
const newText  = document.getElementById("newText");
const topbar   = document.querySelector(".topbar");
const bottom   = document.querySelector(".bottom");

/* å¹…ã‚’CSSå¤‰æ•°ã‹ã‚‰å–å¾—ï¼ˆJSå´ã‚‚ä¸€å…ƒåŒ–ï¼‰ */
const ACTION_W = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--actionW"), 10) || 98;

function uid(){
  try{
    if (crypto && crypto.randomUUID) return crypto.randomUUID();
  }catch{}
  return "id_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2);
}

const KEY="shopping_list_ios_final_v8";
let items=[];
let editMode=false;

/* é–‹ã„ã¦ã„ã‚‹è¡Œï¼ˆé€šå¸¸/ç·¨é›†ï¼‰ */
let openId=null;
let openEditId=null;

/* Drag */
let dragWrap=null;

/* âœ… é–“å»¶ã³è§£æ¶ˆï¼šé•·ã„æ™‚ã ã‘ã‚«ãƒ¼ãƒ‰ã«max-heightï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰ */
function layoutCardHeight(){
  const s = getComputedStyle(app);
  const padTop = parseFloat(s.paddingTop) || 0;
  const padBottom = parseFloat(s.paddingBottom) || 0;

  // â€œï¼‹ãŒä¸‹ã«è¡Œãã™ããªã„â€åˆ†ã®ä½™ç™½ã‚‚ç¢ºä¿ï¼ˆspacerã®maxã‚’æƒ³å®šï¼‰
  const reserve = 80; // spacerä¸Šé™ã¨åˆã‚ã›ã‚‹
  const available = window.innerHeight - topbar.offsetHeight - bottom.offsetHeight - padTop - padBottom - reserve;

  const maxH = Math.max(180, available - 14);
  list.style.maxHeight = maxH + "px";
}

window.addEventListener("resize", layoutCardHeight);
window.addEventListener("orientationchange", layoutCardHeight);

/* =======================
   Utils: Storageï¼ˆç ´æè€æ€§ï¼‰
======================= */
function save(){
  try{ localStorage.setItem(KEY, JSON.stringify(items)); }catch{}
}
function load(){
  const raw = localStorage.getItem(KEY);
  if(!raw){ items=[]; return; }
  try{
    const parsed = JSON.parse(raw);
    if(!Array.isArray(parsed)){ items=[]; return; }
    items = parsed
      .map(x=>({
        id: (x && typeof x.id==="string" && x.id) ? x.id : uid(),
        text: String(x?.text ?? "").trim(),
        done: !!x?.done
      }))
      .filter(x=>x.text);
  }catch{
    items=[];
    try{ localStorage.removeItem(KEY); }catch{}
  }
}

/* =======================
   DOM Helpers
======================= */
function wrapEl(id){ return list.querySelector(`.swipe-wrap[data-id="${CSS.escape(id)}"]`); }
function rowEl(id){ const w=wrapEl(id); return w ? w.querySelector(".row") : null; }

function setRowX(id, x){
  const row = rowEl(id);
  if(!row) return;
  row.style.transform = `translateX(${x}px)`;
}

function closeOpenIfDifferent(id){
  if(openId && openId !== id){
    setRowX(openId, 0);
    openId = null;
  }
}

function closeAllSwipe(){
  if(openId){
    setRowX(openId, 0);
    openId = null;
  }
  if(openEditId){
    const w = wrapEl(openEditId);
    if(w) w.classList.remove("show-actions");
    setRowX(openEditId, 0);
    openEditId = null;
  }
}

/* =======================
   Top actions
======================= */
editBtn.addEventListener("click", ()=>{
  closeAllSwipe();
  editMode=!editMode;
  app.classList.toggle("edit",editMode);
  editBtn.textContent = editMode ? "âœ“" : "ç·¨é›†";
  editBtn.setAttribute("aria-label", editMode ? "ç·¨é›†ãƒ¢ãƒ¼ãƒ‰è§£é™¤" : "ç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ");

  list.querySelectorAll(".swipe-wrap").forEach(w=>{
    const row = w.querySelector(".row");
    const cb = w.querySelector(".cb");
    const minus = w.querySelector(".del");

    cb.disabled = editMode;
    cb.style.pointerEvents = editMode ? "none" : "auto";
    cb.style.opacity = editMode ? ".25" : "1";
    minus.style.display = editMode ? "inline-flex" : "none";

    w.classList.remove("show-actions");
    row.style.transition = "transform .22s var(--spring)";
    row.style.transform = "translateX(0)";
    row._justSwiped = false;
  });

  openId = null;
  openEditId = null;
});

trashBtn.addEventListener("click", ()=>{
  if(confirm("å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
    items=[];
    save();
    list.innerHTML="";
    openId=null;
    openEditId=null;
    layoutCardHeight();
  }
});

/* âœ… å…±æœ‰ï¼šãƒ†ã‚­ã‚¹ãƒˆã ã‘ */
shareBtn.addEventListener("click", async ()=>{
  const text=items.map(i=>`${i.done?"â˜‘":"â˜"} ${i.text}`).join("\n");
  try{
    if(navigator.share){
      await navigator.share({title:"è²·ã„ç‰©ãƒªã‚¹ãƒˆ",text});
    }else{
      await navigator.clipboard.writeText(text);
      alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
    }
  }catch{}
});

plusBtn.addEventListener("click", ()=>{
  if(!inputWrap.classList.contains("show")){
    inputWrap.classList.add("show");
    newText.focus();
    layoutCardHeight();
  }else commitAdd();
});

newText.addEventListener("keydown", e=>{
  if(e.key==="Enter") commitAdd();
  if(e.key==="Escape"){
    inputWrap.classList.remove("show");
    newText.value="";
    layoutCardHeight();
  }
});

function commitAdd(){
  const t=newText.value.trim();
  if(!t) return;
  const it = {id:uid(), text:t, done:false};
  items.push(it);
  save();
  newText.value="";
  inputWrap.classList.add("show");
  newText.focus();

  list.appendChild(buildRow(it));
  layoutCardHeight();
}

/* =======================
   Global close behavior
======================= */
document.addEventListener("pointerdown",(e)=>{
  if(e.target.closest(".swipe-wrap")) return;
  if(e.target.closest(".actions")) return;
  closeAllSwipe();
},{capture:true});

/* =======================
   Render
======================= */
function renderAll(){
  list.innerHTML="";
  items.forEach(it=> list.appendChild(buildRow(it)));
}

/* =======================
   Build row DOM
======================= */
function buildRow(it){
  const wrap=document.createElement("div");
  wrap.className="swipe-wrap";
  wrap.dataset.id=it.id;
  wrap.setAttribute("role","listitem");

  // actions
  const actions=document.createElement("div");
  actions.className="actions";
  const delBtn=document.createElement("button");
  delBtn.type="button";
  delBtn.textContent="å‰Šé™¤";
  delBtn.setAttribute("aria-label", `å‰Šé™¤: ${it.text}`);
  delBtn.addEventListener("click", ()=>removeOne(it.id));
  actions.appendChild(delBtn);
  wrap.appendChild(actions);

  // row
  const row=document.createElement("div");
  row.className="row";
  row.style.transform="translateX(0)";
  row._justSwiped = false;

  // left (minus)
  const left=document.createElement("div");
  left.className="leftSlot";
  const minus=document.createElement("button");
  minus.className="del";
  minus.innerHTML='<span class="minus-bar" aria-hidden="true"></span>';
  minus.type="button";
  minus.style.display = editMode ? "inline-flex" : "none";
  minus.setAttribute("aria-label", `å‰Šé™¤ãƒ¡ãƒ‹ãƒ¥ãƒ¼: ${it.text}`);

  minus.addEventListener("click", ()=>{
    if(!editMode) return;

    if(openEditId && openEditId !== it.id){
      const prev = wrapEl(openEditId);
      if(prev) prev.classList.remove("show-actions");
      setRowX(openEditId, 0);
    }
    const willOpen = openEditId !== it.id;
    openEditId = willOpen ? it.id : null;
    wrap.classList.toggle("show-actions", willOpen);
    setRowX(it.id, willOpen ? -ACTION_W : 0);
  });

  left.appendChild(minus);
  row.appendChild(left);

  // checkbox
  const cb=document.createElement("input");
  cb.type="checkbox";
  cb.className="cb";
  cb.checked=!!it.done;
  cb.disabled=editMode;
  cb.setAttribute("aria-label", `å®Œäº†åˆ‡ã‚Šæ›¿ãˆ: ${it.text}`);
  cb.addEventListener("change", ()=>toggleDone(it.id, cb.checked));
  row.appendChild(cb);

  // textï¼ˆã‚¯ãƒªãƒƒã‚¯/Enter/Spaceã§å®Œäº†åˆ‡æ›¿ï¼‰
  const text=document.createElement("div");
  text.className="text" + (it.done ? " checked":"");
  text.textContent=it.text;
  text.setAttribute("role","button");
  text.setAttribute("tabindex","0");
  text.setAttribute("aria-label", `é …ç›®: ${it.text}ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å®Œäº†åˆ‡æ›¿ï¼‰`);
  text.addEventListener("click", ()=>{
    if(editMode) return;
    cb.checked = !cb.checked;
    toggleDone(it.id, cb.checked);
  });
  text.addEventListener("keydown", (e)=>{
    if(editMode) return;
    if(e.key==="Enter" || e.key===" "){
      e.preventDefault();
      cb.checked = !cb.checked;
      toggleDone(it.id, cb.checked);
    }
  });
  row.appendChild(text);

  // handle
  const right=document.createElement("div");
  right.className="rightSlot";
  const handle=document.createElement("div");
  handle.className="handle";
  handle.textContent="â‰¡";
  handle.setAttribute("aria-label","ä¸¦ã¹æ›¿ãˆãƒãƒ³ãƒ‰ãƒ«");
  handle.addEventListener("pointerdown", e=>{
    if(!editMode) return;
    e.preventDefault();
    e.stopPropagation();
    startDrag(e, wrap);
  });
  right.appendChild(handle);
  row.appendChild(right);

  // row clickï¼ˆã‚¹ãƒ¯ã‚¤ãƒ—ç›´å¾ŒclickæŠ‘æ­¢ï¼‰
  row.addEventListener("click",(e)=>{
    if(row._justSwiped){
      row._justSwiped = false;
      return;
    }

    if(editMode){
      if(e.target.closest(".del")) return;
      if(e.target.closest(".actions")) return;
      if(openEditId){
        const w = wrapEl(openEditId);
        if(w) w.classList.remove("show-actions");
        setRowX(openEditId, 0);
        openEditId = null;
      }
    }else{
      if(openId===it.id){
        setRowX(it.id, 0);
        openId=null;
      }
    }
  });

  // swipe only in normal mode
  attachSwipe(row, it.id);

  wrap.appendChild(row);
  return wrap;
}

/* =======================
   State ops
======================= */
function toggleDone(id,val){
  if(editMode) return;
  const it=items.find(x=>x.id===id);
  if(!it) return;
  it.done = !!val;
  save();

  const w = wrapEl(id);
  if(!w) return;
  const text = w.querySelector(".text");
  text.classList.toggle("checked", it.done);

  const cb = w.querySelector(".cb");
  if(cb) cb.checked = it.done;
}

function removeOne(id){
  items = items.filter(x=>x.id!==id);
  save();

  const w = wrapEl(id);
  if(w) w.remove();

  if(openId===id) openId=null;
  if(openEditId===id) openEditId=null;

  layoutCardHeight();
}

/* =======================
   âœ… ã‚¹ãƒ¯ã‚¤ãƒ—å‰Šé™¤ï¼šã•ã‚‰ã«â€œåŠ¹ãã‚„ã™ãâ€ã—ãŸç‰ˆ
   ãƒã‚¤ãƒ³ãƒˆï¼š
   - .textä¸Šã‹ã‚‰ã‚‚ã‚¹ãƒ¯ã‚¤ãƒ—é–‹å§‹OKï¼ˆã“ã“ãŒåŠ¹ãã¥ã‚‰ã•ã®ä¸»å› ã«ãªã‚ŠãŒã¡ï¼‰
   - æ¨ªåˆ¤å®šã‚’å°‘ã—ç”˜ãï¼ˆæ–œã‚ã§ã‚‚æ‹¾ã†ï¼‰
   - æ¨ªç¢ºå®šå¾Œã¯ capture + preventDefault ã§ä¸»å°æ¨©ã‚’å–ã‚‹
======================= */
function attachSwipe(row,id){
  let startX=0, startY=0;
  let swiping=false;
  let active=false;
  let baseX=0;
  let pid=null;

  // âœ… â€œã‚¹ãƒ¯ã‚¤ãƒ—é–‹å§‹ã‚’é˜»å®³ã™ã‚‹è¦ç´ â€ã‚’æœ€å°é™ã«
  // .text ã¯é™¤å¤–ã—ãªã„ï¼ˆï¼ãƒ†ã‚­ã‚¹ãƒˆä¸Šã‹ã‚‰ã§ã‚‚ã‚¹ãƒ¯ã‚¤ãƒ—ã§ãã‚‹ï¼‰
  const isInteractive = (t) => !!t.closest("input,button,.handle,.del");

  row.addEventListener("pointerdown",(e)=>{
    if(editMode) return;
    if(isInteractive(e.target)) return;

    closeOpenIfDifferent(id);

    active = true;
    pid = e.pointerId;
    startX = e.clientX;
    startY = e.clientY;
    swiping = false;

    baseX = (openId===id) ? -ACTION_W : 0;
    row.style.transition="none";

    try{ row.setPointerCapture(pid); }catch{}
  }, {passive:true});

  row.addEventListener("pointermove",(e)=>{
    if(editMode || !active) return;

    const dx = e.clientX - startX;
    const dy = e.clientY - startY;

    if(!swiping){
      // âœ… å…¥ã‚Šã‚’æ—©ã
      if(Math.abs(dx) < 7) return;

      // âœ… æ–œã‚ã§ã‚‚æ‹¾ã†ï¼šdyãŒå°‘ã—å¤§ããã¦ã‚‚æ¨ªã¨ã¿ãªã™
      // ä¾‹ï¼‰|dx| > |dy| * 0.85 ãªã‚‰æ¨ªæ‰±ã„
      if(Math.abs(dx) <= Math.abs(dy) * 0.85) return;

      swiping = true;
    }

    // âœ… æ¨ªç¢ºå®šå¾Œã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç­‰ã‚’æŠ‘åˆ¶
    e.preventDefault();

    let x = baseX + dx;
    x = Math.min(0, Math.max(-ACTION_W, x));
    row.style.transform = `translateX(${x}px)`;
  }, {passive:false});

  const end = ()=>{
    if(editMode || !active) return;

    if(!swiping){
      if(openId===id){
        row.style.transition="transform .22s var(--spring)";
        row.style.transform="translateX(0)";
        openId=null;
      }
      active=false;
      return;
    }

    const tr=getComputedStyle(row).transform;
    let x=0;
    if(tr && tr!=="none"){
      const m=tr.match(/matrix\(([^)]+)\)/);
      if(m){
        const parts=m[1].split(",").map(v=>parseFloat(v));
        x=parts[4]||0;
      }
    }

    row.style.transition="transform .22s var(--spring)";
    const willOpen = (x <= -ACTION_W/2);
    row.style.transform = `translateX(${willOpen ? -ACTION_W : 0}px)`;
    openId = willOpen ? id : null;

    row._justSwiped = true;
    setTimeout(()=>{ row._justSwiped = false; }, 0);

    active=false;
  };

  row.addEventListener("pointerup", end, {passive:true});
  row.addEventListener("pointercancel", end, {passive:true});
}

/* =======================
   Drag reorder (edit mode)
======================= */
function startDrag(e,wrap){
  if(openEditId){
    const w = wrapEl(openEditId);
    if(w) w.classList.remove("show-actions");
    setRowX(openEditId, 0);
    openEditId = null;
  }

  dragWrap=wrap;
  const row=wrap.querySelector(".row");
  row.classList.add("dragging");

  const move=ev=>{
    const after=getAfter(ev.clientY);
    if(after==null) list.appendChild(dragWrap);
    else list.insertBefore(dragWrap,after);
  };
  const up=()=>{
    row.classList.remove("dragging");
    dragWrap=null;
    persistOrder();
    window.removeEventListener("pointermove",move);
    window.removeEventListener("pointerup",up);
    window.removeEventListener("pointercancel",up);
  };

  window.addEventListener("pointermove",move,{passive:false});
  window.addEventListener("pointerup",up,{passive:false});
  window.addEventListener("pointercancel",up,{passive:false});
}

function getAfter(y){
  const els=[...list.querySelectorAll(".swipe-wrap")].filter(w=>w!==dragWrap);
  let closest={offset:-Infinity,el:null};
  els.forEach(w=>{
    const box=w.getBoundingClientRect();
    const offset=y-box.top-box.height/2;
    if(offset<0&&offset>closest.offset) closest={offset,el:w};
  });
  return closest.el;
}

function persistOrder(){
  const ordered=[...list.querySelectorAll(".swipe-wrap")].map(w=>w.dataset.id);
  const map=new Map(items.map(i=>[i.id,i]));
  items = ordered.map(id=>map.get(id)).filter(Boolean);
  save();
}

/* init */
load();
renderAll();
layoutCardHeight();
</script>
</body>
</html>
