<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Ë≤∑„ÅÑÁâ©„É™„Çπ„Éà</title>

<style>
:root{
  --bg:#000;
  --card:#1c1c1e;
  --line:rgba(255,255,255,.08);
  --text:#fff;
  --accent:#ff375f;
  --danger:#ff3b30;
  --radius:24px;
}
*{box-sizing:border-box;}
html,body{
  height:100%;
  -webkit-text-size-adjust:100%;
}
body{
  margin:0;
  background:var(--bg);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
  display:flex;
  justify-content:center;
  color:var(--text);
  -webkit-user-select:none;
  user-select:none;
  touch-action:manipulation;
}
button, input, .row, .card{ -webkit-user-select:none; user-select:none; }
input{ -webkit-user-select:text; user-select:text; }

.phone{
  width:390px;
  min-height:100vh;
  padding:14px;
}

/* ===== Top ===== */
.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:14px;
}
.top-left,.top-right{
  display:flex;
  gap:12px;
  align-items:center;
}
.title{
  font-weight:900;
  font-size:20px;
  letter-spacing:.02em;
}

/* Buttons bigger */
.iconbtn, .editbtn{
  border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.10);
  color:var(--accent);
  padding:12px 18px;
  font-weight:900;
  font-size:18px;
  min-height:52px;
}

/* ===== Card ===== */
.card{
  background:var(--card);
  border-radius:var(--radius);
  overflow:hidden;
}

/* ===== Swipe ===== */
.swipe-wrap{ position:relative; overflow:hidden; }
.actions{
  position:absolute;
  top:0; right:0; bottom:0;
  display:flex;
}
.actions button{
  width:98px;
  border:none;
  background:var(--danger);
  color:#fff;
  font-weight:900;
  font-size:16px;
}

/* ===== Row ===== */
.row{
  display:flex;
  align-items:center;
  gap:12px;
  padding:18px 16px;
  border-bottom:1px solid var(--line);
  background:var(--card);
  transition:transform .18s ease;
  -webkit-touch-callout:none;
}
.row:last-child{border-bottom:none;}
.dragging{ opacity:.35; }

/* edit left delete */
.del{
  display:none;
  width:30px;height:30px;
  border-radius:999px;
  background:var(--accent);
  color:#fff;
  border:none;
  font-size:18px;
  font-weight:900;
}
.edit .del{ display:flex; justify-content:center; align-items:center; }

/* checkbox */
.cb{ width:26px; height:26px; }
.edit .cb{ opacity:.25; pointer-events:none; }

.text{ flex:1; font-size:18px; line-height:1.2; }
.checked{ text-decoration:line-through; opacity:.5; }

/* handle: IMPORTANT touch-action none */
.handle{
  display:none;
  font-size:24px;
  cursor:grab;
  padding:8px 10px;
  border-radius:10px;
  color:rgba(255,255,255,.6);
  touch-action:none;              /* ‚úÖ „Åì„Çå„ÅåË∂ÖÈáçË¶Å */
}
.edit .handle{ display:block; }

/* ===== Add ===== */
.bottom{ margin-top:14px; }
.plus{
  width:60px;height:60px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.10);
  font-size:30px;
  color:#fff;
}
.inputwrap{ display:none; margin-top:10px; }
.inputwrap.show{ display:block; }
.input{
  width:100%;
  height:56px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.10);
  color:#fff;
  padding:0 14px;
  font-size:16px;
}
</style>
</head>

<body>
<div class="phone" id="app">

  <div class="topbar">
    <div class="top-left">
      <button class="iconbtn" id="trashBtn" aria-label="ÂÖ®ÂâäÈô§">üóë</button>
      <button class="editbtn" id="editBtn" aria-label="Á∑®ÈõÜ">Á∑®ÈõÜ</button>
    </div>
    <div class="title">„É™„Çπ„Éà</div>
    <div class="top-right">
      <button class="iconbtn" id="shareBtn" aria-label="ÂÖ±Êúâ">ÂÖ±Êúâ</button>
    </div>
  </div>

  <div class="card" id="list"></div>

  <div class="bottom">
    <button class="plus" id="plusBtn" aria-label="ËøΩÂä†">Ôºã</button>
    <div class="inputwrap" id="inputWrap">
      <input class="input" id="newText" placeholder="Ë≤∑„ÅÜ„ÇÇ„ÅÆ„ÇíÂÖ•Âäõ‚Ä¶" />
    </div>
  </div>

</div>

<script>
/* block context menu / gestures */
document.addEventListener("contextmenu", (e) => e.preventDefault(), { passive:false });
document.addEventListener("gesturestart", (e) => e.preventDefault(), { passive:false });
document.addEventListener("gesturechange", (e) => e.preventDefault(), { passive:false });
document.addEventListener("gestureend", (e) => e.preventDefault(), { passive:false });

const KEY="shopping_list_stable_v4";
let items=[];
let editMode=false;
let openId=null;

// drag state
let dragWrap=null;

load();
render();

/* ===== Header ===== */
editBtn.onclick=()=>{
  editMode=!editMode;
  app.classList.toggle("edit",editMode);
  editBtn.textContent=editMode?"‚úì":"Á∑®ÈõÜ";
  openId=null;
  render();
};

trashBtn.onclick=()=>{
  if(confirm("ÂÖ®ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")){
    items=[];save();render();
  }
};

shareBtn.onclick=async()=>{
  const text=items.map(i=>`${i.done?"‚òë":"‚òê"} ${i.text}`).join("\n");
  try{
    if(navigator.share){
      await navigator.share({ title:"Ë≤∑„ÅÑÁâ©„É™„Çπ„Éà", text });
    }else{
      await navigator.clipboard.writeText(text);
      alert("„É™„Çπ„Éà„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü");
    }
  }catch{}
};

/* ===== Add ===== */
plusBtn.onclick=()=>{
  if(!inputWrap.classList.contains("show")){
    inputWrap.classList.add("show");
    newText.focus();
  }else commitAdd();
};
newText.onkeydown=e=>{
  if(e.key==="Enter")commitAdd();
  if(e.key==="Escape"){ inputWrap.classList.remove("show"); newText.value=""; }
};
function commitAdd(){
  const text=newText.value.trim();
  if(!text)return;
  items.push({id:crypto.randomUUID(),text,done:false});
  newText.value="";
  save();render();
}

/* ===== Data ===== */
function toggle(id,val){
  if(editMode) return; // Á∑®ÈõÜ‰∏≠„ÅØ„ÉÅ„Çß„ÉÉ„ÇØ‰∏çÂèØ
  const it=items.find(i=>i.id===id);
  if(it){it.done=val;save();render();}
}
function removeOne(id){
  items=items.filter(i=>i.id!==id);
  save();render();
}
function save(){ localStorage.setItem(KEY, JSON.stringify(items)); }
function load(){
  try{
    const raw=localStorage.getItem(KEY);
    items=raw?JSON.parse(raw):[
      {id:crypto.randomUUID(), text:"Á¥çË±Ü", done:false},
      {id:crypto.randomUUID(), text:"È£ü„Éë„É≥ 5Êûö", done:false},
      {id:crypto.randomUUID(), text:"Âçµ", done:false},
    ];
    if(!Array.isArray(items)) items=[];
  }catch{ items=[]; }
}

/* ===== Render ===== */
function render(){
  list.innerHTML="";
  items.forEach(it=>{
    const wrap=document.createElement("div");
    wrap.className="swipe-wrap";
    wrap.dataset.id=it.id;

    const actions=document.createElement("div");
    actions.className="actions";
    const delBtn=document.createElement("button");
    delBtn.textContent="ÂâäÈô§";
    delBtn.onclick=()=>removeOne(it.id);
    actions.appendChild(delBtn);

    const row=document.createElement("div");
    row.className="row";

    // swipe open only when not editing
    row.style.transform=(!editMode && openId===it.id) ? "translateX(-98px)" : "translateX(0)";

    const del=document.createElement("button");
    del.className="del";
    del.textContent="‚àí";
    del.onclick=()=>removeOne(it.id);
    row.appendChild(del);

    const cb=document.createElement("input");
    cb.type="checkbox";
    cb.className="cb";
    cb.checked=it.done;
    cb.onchange=()=>toggle(it.id,cb.checked);
    cb.disabled = editMode; // ‚úÖ Á∑®ÈõÜ‰∏≠„ÅØÁâ©ÁêÜÁöÑ„Å´ÁÑ°Âäπ
    row.appendChild(cb);

    const text=document.createElement("div");
    text.className="text"+(it.done?" checked":"");
    text.textContent=it.text;
    row.appendChild(text);

    const handle=document.createElement("div");
    handle.className="handle";
    handle.textContent="‚â°";
    handle.onpointerdown=(e)=>startDrag(e,wrap);
    row.appendChild(handle);

    attachSwipe(row,it.id);

    wrap.appendChild(actions);
    wrap.appendChild(row);
    list.appendChild(wrap);
  });
}

/* ===== SwipeÔºàÈï∑Êäº„ÅóË™§Áô∫ÁÅ´„ÇíÊΩ∞„ÅôÔºâ =====
   - input/button/handle „Åã„Çâ„ÅØÈñãÂßã„Åó„Å™„ÅÑ
   - Ê®™ÁßªÂãï„Åå‰∏ÄÂÆö‰ª•‰∏ä & "Áü≠ÊôÇÈñì" „ÅÆ„Å®„Åç„ÅÆ„ÅøÈñãÂßãÔºàÈï∑Êäº„Åó‚ÜíÂæÆÂãï„Åß„ÅØÈñãÂßã„Åó„Å™„ÅÑÔºâ
*/
function attachSwipe(row,id){
  let startX=0,startY=0,startT=0;
  let swiping=false,currentX=0;

  const isInteractive=t=>!!t.closest("input,button,.handle");

  row.onpointerdown=e=>{
    if(editMode || isInteractive(e.target)) return;
    startX=e.clientX;
    startY=e.clientY;
    startT=performance.now();
    swiping=false;
    row.style.transition="none";
  };

  row.onpointermove=e=>{
    if(editMode || startX===0) return;

    const dx=e.clientX-startX;
    const dy=e.clientY-startY;
    const dt=performance.now()-startT;

    // ‚ë† Â∞è„Åï„ÅÑÂãï„Åç„ÅØÁÑ°Ë¶ñ
    if(!swiping && Math.abs(dx) < 14) return;

    // ‚ë° Á∏¶„Çπ„ÇØ„É≠„Éº„É´ÂÑ™ÂÖà
    if(!swiping && Math.abs(dx) <= Math.abs(dy)) return;

    // ‚ë¢ Èï∑Êäº„Åó„Åó„Å¶„Åã„Çâ„ÅÆ„Çπ„ÉØ„Ç§„ÉóÈñãÂßã„ÇíÊäëÂà∂ÔºàÈï∑Êäº„ÅóË™§Áô∫ÁÅ´ÂØæÁ≠ñÔºâ
    //    ‰æã„Åà„Å∞ 350ms ‰ª•‰∏äÁµå„Å£„Å¶„Åã„Çâ„ÅÆÈñãÂßã„ÅØÁÑ°Ë¶ñÔºàÂâäÈô§„ÇíÂá∫„Åï„Å™„ÅÑÔºâ
    if(!swiping && dt > 350) return;

    swiping = true;

    currentX = Math.min(0, Math.max(-98, dx));
    row.style.transform = `translateX(${currentX}px)`;
  };

  row.onpointerup=()=>{
    if(editMode) return;
    if(!swiping){ startX=0; return; }

    row.style.transition="transform .18s ease";
    openId = (currentX <= -49) ? id : null;
    startX=0;
    render();
  };

  row.onpointercancel = row.onpointerup;
}

/* ===== Drag reorderÔºàÁ∑®ÈõÜÊôÇ„ÄÅ‚â°„ÅßÁ¢∫ÂÆü„Å´Âãï„ÅèÁâàÔºâ ===== */
function startDrag(e,wrap){
  if(!editMode) return;

  // ‚úÖ Êó¢ÂÆöÂãï‰Ωú„ÇíÊÆ∫„Åó„Å¶Á¢∫ÂÆü„Å´„Éâ„É©„ÉÉ„Ç∞„Å∏
  e.preventDefault();

  dragWrap = wrap;
  const row = wrap.querySelector(".row");
  row.classList.add("dragging");

  // Á∑®ÈõÜÊôÇ„ÅØ transform „Çí‰Ωø„Çè„Å™„ÅÑÔºàË®àÁÆó„Ç∫„É¨Èò≤Ê≠¢Ôºâ
  row.style.transform = "translateX(0)";

  const move = (ev) => {
    if(!dragWrap) return;
    const after = getAfter(ev.clientY);
    if(after == null) list.appendChild(dragWrap);
    else list.insertBefore(dragWrap, after);
  };

  const up = () => {
    if(!dragWrap) return;
    dragWrap.querySelector(".row").classList.remove("dragging");
    dragWrap = null;
    persist();
    window.removeEventListener("pointermove", move);
    window.removeEventListener("pointerup", up);
    window.removeEventListener("pointercancel", up);
  };

  window.addEventListener("pointermove", move, { passive:false });
  window.addEventListener("pointerup", up, { passive:false });
  window.addEventListener("pointercancel", up, { passive:false });
}

function getAfter(y){
  const els=[...list.querySelectorAll(".swipe-wrap")].filter(w=>w!==dragWrap);
  let closest={offset:-Infinity,el:null};
  for(const w of els){
    const box=w.getBoundingClientRect();
    const offset=y-box.top-box.height/2;
    if(offset<0 && offset>closest.offset){
      closest={offset,el:w};
    }
  }
  return closest.el;
}

function persist(){
  const ordered=[...list.querySelectorAll(".swipe-wrap")].map(w=>w.dataset.id);
  const map=new Map(items.map(i=>[i.id,i]));
  items=ordered.map(id=>map.get(id)).filter(Boolean);
  save();
}
</script>
</body>
</html>
